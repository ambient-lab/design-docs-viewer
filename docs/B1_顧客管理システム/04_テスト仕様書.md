# テスト仕様書

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | B1 顧客管理システム テスト仕様書 |
| バージョン | 2.0 |
| 作成日 | 2025-11-27 |
| 対象システム | 顧客管理システム REST API (Next.js App Router) |

## 目次

1. [概要](#概要)
2. [単体テスト仕様](#単体テスト仕様)
3. [結合テスト仕様](#結合テスト仕様)
4. [テストデータ](#テストデータ)
5. [テスト実行環境](#テスト実行環境)
6. [期待結果定義](#期待結果定義)

---

## 概要

### テスト対象API一覧

| API ID | API名 | HTTPメソッド | エンドポイント |
|--------|-------|-------------|---------------|
| B10101 | 顧客検索API | GET | /api/customers |
| B10102 | 顧客詳細取得API | GET | /api/customers/[id] |
| B10103 | 顧客登録API | POST | /api/customers |
| B10104 | 顧客更新API | PUT | /api/customers/[id] |
| B10105 | 顧客削除API | DELETE | /api/customers/[id] |

### テスト環境

| 項目 | 内容 |
|------|------|
| 開発言語 | TypeScript |
| フレームワーク | Next.js 15.x (App Router) |
| データベース | PostgreSQL / SQLite (テスト用) |
| テストフレームワーク | Jest 29.x, Supertest |
| ORMライブラリ | Prisma 6.x |

### テストツール構成

```json
{
  "jest": "^29.7.0",
  "@types/jest": "^29.5.0",
  "supertest": "^6.3.0",
  "@types/supertest": "^6.0.0",
  "ts-jest": "^29.1.0",
  "prisma": "^6.0.0",
  "@prisma/client": "^6.0.0"
}
```

---

## 単体テスト仕様

### テスト構成

```
__tests__/
├── api/
│   ├── customers/
│   │   ├── route.test.ts          # B10101, B10103
│   │   └── [id]/
│   │       └── route.test.ts      # B10102, B10104, B10105
│   └── setup.ts                   # テスト共通設定
├── fixtures/
│   ├── customers.json             # モックデータ
│   └── invalid-customers.json     # バリデーションエラー用データ
└── utils/
    ├── test-helpers.ts            # テストヘルパー関数
    └── prisma-test-helper.ts      # Prismaテストユーティリティ
```

---

### B10101: 顧客検索API (GET /api/customers)

#### テストケース一覧

| テストID | テスト名 | テスト区分 | 事前条件 | 入力値 | 期待結果 | HTTPステータス |
|---------|---------|-----------|---------|--------|---------|---------------|
| B10101-T01 | 全件検索_正常系 | 正常系 | 顧客データが3件登録済み | クエリパラメータなし | 全3件の顧客情報を返却 | 200 OK |
| B10101-T02 | 顧客名検索_正常系_完全一致 | 正常系 | 顧客データが3件登録済み | name=山田太郎 | 該当する1件の顧客情報を返却 | 200 OK |
| B10101-T03 | 顧客名検索_正常系_部分一致 | 正常系 | 顧客データが3件登録済み | name=山田 | 該当する顧客情報を返却 | 200 OK |
| B10101-T04 | メールアドレス検索_正常系 | 正常系 | 顧客データが3件登録済み | email=yamada@example.com | 該当する1件の顧客情報を返却 | 200 OK |
| B10101-T05 | 電話番号検索_正常系 | 正常系 | 顧客データが3件登録済み | phone=090-1234-5678 | 該当する1件の顧客情報を返却 | 200 OK |
| B10101-T06 | 複合条件検索_正常系 | 正常系 | 顧客データが3件登録済み | name=山田&email=yamada@example.com | 両条件に一致する顧客情報を返却 | 200 OK |
| B10101-T07 | 検索結果0件_正常系 | 正常系 | 顧客データが3件登録済み | name=存在しない顧客 | 空の配列を返却 | 200 OK |
| B10101-T08 | ページネーション_正常系 | 正常系 | 顧客データが10件登録済み | page=1&limit=5 | 5件の顧客情報とページング情報を返却 | 200 OK |
| B10101-T09 | ソート指定_正常系 | 正常系 | 顧客データが3件登録済み | sort=name&order=asc | 顧客名の昇順で返却 | 200 OK |
| B10101-T10 | 無効なパラメータ_異常系 | 異常系 | 顧客データが3件登録済み | page=-1 | エラーメッセージを返却 | 400 Bad Request |

#### 実装例

**__tests__/api/customers/route.test.ts**

```typescript
import { testApiHandler } from 'next-test-api-route-handler';
import * as customersHandler from '@/app/api/customers/route';
import { prisma } from '@/lib/prisma';
import { setupTestDatabase, cleanupTestDatabase, seedCustomers } from '@/__tests__/utils/prisma-test-helper';
import { mockCustomers } from '@/__tests__/fixtures/customers';

describe('GET /api/customers - B10101 顧客検索API', () => {
  beforeAll(async () => {
    await setupTestDatabase();
  });

  beforeEach(async () => {
    await cleanupTestDatabase();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  describe('正常系', () => {
    test('B10101-T01: 全件検索_正常系', async () => {
      // 事前条件: 3件の顧客データを登録
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'GET' });
          const data = await res.json();

          // 検証
          expect(res.status).toBe(200);
          expect(data).toHaveLength(3);
          expect(data[0]).toHaveProperty('id');
          expect(data[0]).toHaveProperty('name');
          expect(data[0]).toHaveProperty('email');
          expect(data[0]).toHaveProperty('phone');
          expect(data[0]).toHaveProperty('address');
          expect(data[0]).toHaveProperty('createdAt');
          expect(data[0]).toHaveProperty('updatedAt');
        },
      });
    });

    test('B10101-T02: 顧客名検索_正常系_完全一致', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { name: '山田太郎' },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data).toHaveLength(1);
          expect(data[0].name).toBe('山田太郎');
        },
      });
    });

    test('B10101-T03: 顧客名検索_正常系_部分一致', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { name: '山田' },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.length).toBeGreaterThan(0);
          data.forEach((customer: any) => {
            expect(customer.name).toContain('山田');
          });
        },
      });
    });

    test('B10101-T04: メールアドレス検索_正常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { email: 'yamada.taro@example.com' },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data).toHaveLength(1);
          expect(data[0].email).toBe('yamada.taro@example.com');
        },
      });
    });

    test('B10101-T05: 電話番号検索_正常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { phone: '090-1234-5678' },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data).toHaveLength(1);
          expect(data[0].phone).toBe('090-1234-5678');
        },
      });
    });

    test('B10101-T06: 複合条件検索_正常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: {
              name: '山田',
              email: 'yamada.taro@example.com',
            },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data).toHaveLength(1);
          expect(data[0].name).toContain('山田');
          expect(data[0].email).toBe('yamada.taro@example.com');
        },
      });
    });

    test('B10101-T07: 検索結果0件_正常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { name: '存在しない顧客名' },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data).toEqual([]);
        },
      });
    });

    test('B10101-T08: ページネーション_正常系', async () => {
      await seedCustomers(mockCustomers); // 10件登録

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: {
              page: '1',
              limit: '5',
            },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.items).toHaveLength(5);
          expect(data.pagination).toEqual({
            page: 1,
            limit: 5,
            total: 10,
            totalPages: 2,
          });
        },
      });
    });

    test('B10101-T09: ソート指定_正常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: {
              sort: 'name',
              order: 'asc',
            },
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.length).toBeGreaterThan(1);

          // ソート順の検証
          for (let i = 0; i < data.length - 1; i++) {
            expect(data[i].name <= data[i + 1].name).toBe(true);
          }
        },
      });
    });
  });

  describe('異常系', () => {
    test('B10101-T10: 無効なパラメータ_異常系', async () => {
      await seedCustomers(mockCustomers.slice(0, 3));

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'GET',
            params: { page: '-1' },
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data).toHaveProperty('error');
          expect(data.message).toContain('無効なパラメータ');
        },
      });
    });
  });
});

describe('POST /api/customers - B10103 顧客登録API', () => {
  beforeEach(async () => {
    await cleanupTestDatabase();
  });

  describe('正常系', () => {
    test('B10103-T01: 顧客登録_正常系_全項目', async () => {
      const newCustomer = {
        name: '山田太郎',
        email: 'yamada@example.com',
        phone: '090-1234-5678',
        address: '東京都渋谷区1-2-3',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(201);
          expect(data).toHaveProperty('id');
          expect(data.name).toBe(newCustomer.name);
          expect(data.email).toBe(newCustomer.email);
          expect(data.phone).toBe(newCustomer.phone);
          expect(data.address).toBe(newCustomer.address);
          expect(data).toHaveProperty('createdAt');
          expect(data).toHaveProperty('updatedAt');

          // Locationヘッダーの確認
          expect(res.headers.get('Location')).toBe(`/api/customers/${data.id}`);
        },
      });
    });

    test('B10103-T02: 顧客登録_正常系_必須項目のみ', async () => {
      const newCustomer = {
        name: '佐藤花子',
        email: 'sato@example.com',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(201);
          expect(data).toHaveProperty('id');
          expect(data.name).toBe(newCustomer.name);
          expect(data.email).toBe(newCustomer.email);
          expect(data.phone).toBeNull();
          expect(data.address).toBeNull();
        },
      });
    });
  });

  describe('異常系', () => {
    test('B10103-T03: 顧客名未入力_異常系', async () => {
      const invalidCustomer = {
        email: 'test@example.com',
        phone: '090-1234-5678',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'name',
              message: '顧客名は必須です',
            })
          );
        },
      });
    });

    test('B10103-T04: メールアドレス未入力_異常系', async () => {
      const invalidCustomer = {
        name: '田中一郎',
        phone: '090-1234-5678',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'email',
              message: 'メールアドレスは必須です',
            })
          );
        },
      });
    });

    test('B10103-T05: メールアドレス形式不正_異常系', async () => {
      const invalidCustomer = {
        name: '田中一郎',
        email: 'invalid-email-format',
        phone: '090-1234-5678',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'email',
              message: 'メールアドレスの形式が正しくありません',
            })
          );
        },
      });
    });

    test('B10103-T06: 重複メールアドレス_異常系', async () => {
      // 事前条件: 既存顧客を登録
      await seedCustomers([
        {
          name: '既存顧客',
          email: 'test@example.com',
          phone: '090-0000-0000',
          address: '東京都',
        },
      ]);

      const duplicateCustomer = {
        name: '新規顧客',
        email: 'test@example.com', // 重複
        phone: '090-9999-9999',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(duplicateCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(409);
          expect(data.message).toBe('メールアドレスが既に登録されています');
          expect(data.conflictField).toBe('email');
          expect(data.conflictValue).toBe('test@example.com');
        },
      });
    });

    test('B10103-T07: 電話番号形式不正_異常系', async () => {
      const invalidCustomer = {
        name: '田中一郎',
        email: 'tanaka@example.com',
        phone: '123', // 不正な形式
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'phone',
              message: '電話番号の形式が正しくありません',
            })
          );
        },
      });
    });

    test('B10103-T08: 顧客名長さ超過_異常系', async () => {
      const invalidCustomer = {
        name: 'あ'.repeat(101), // 101文字
        email: 'test@example.com',
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'name',
              message: '顧客名は100文字以内で入力してください',
            })
          );
        },
      });
    });

    test('B10103-T09: 住所長さ超過_異常系', async () => {
      const invalidCustomer = {
        name: '田中一郎',
        email: 'test@example.com',
        address: 'あ'.repeat(256), // 256文字
      };

      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invalidCustomer),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'address',
              message: '住所は255文字以内で入力してください',
            })
          );
        },
      });
    });

    test('B10103-T10: 空のリクエストボディ_異常系', async () => {
      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors.length).toBeGreaterThan(0);
        },
      });
    });
  });
});
```

---

### B10102: 顧客詳細取得API (GET /api/customers/[id])

#### テストケース一覧

| テストID | テスト名 | テスト区分 | 事前条件 | 入力値 | 期待結果 | HTTPステータス |
|---------|---------|-----------|---------|--------|---------|---------------|
| B10102-T01 | 顧客詳細取得_正常系 | 正常系 | 顧客ID=1が登録済み | id=1 | 該当顧客の詳細情報を返却 | 200 OK |
| B10102-T02 | 存在しない顧客ID_異常系 | 異常系 | 顧客データが登録済み | id=99999 | エラーメッセージを返却 | 404 Not Found |
| B10102-T03 | 無効な顧客ID形式_異常系 | 異常系 | 顧客データが登録済み | id=abc | エラーメッセージを返却 | 400 Bad Request |
| B10102-T04 | マイナス顧客ID_異常系 | 異常系 | 顧客データが登録済み | id=-1 | エラーメッセージを返却 | 400 Bad Request |

#### 実装例

**__tests__/api/customers/[id]/route.test.ts**

```typescript
import { testApiHandler } from 'next-test-api-route-handler';
import * as customerIdHandler from '@/app/api/customers/[id]/route';
import { prisma } from '@/lib/prisma';
import { setupTestDatabase, cleanupTestDatabase, seedCustomers } from '@/__tests__/utils/prisma-test-helper';

describe('GET /api/customers/[id] - B10102 顧客詳細取得API', () => {
  let testCustomerId: number;

  beforeAll(async () => {
    await setupTestDatabase();
  });

  beforeEach(async () => {
    await cleanupTestDatabase();

    // テスト用顧客を1件登録
    const customers = await seedCustomers([
      {
        name: '山田太郎',
        email: 'yamada@example.com',
        phone: '090-1234-5678',
        address: '東京都渋谷区1-2-3',
      },
    ]);
    testCustomerId = customers[0].id;
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  describe('正常系', () => {
    test('B10102-T01: 顧客詳細取得_正常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'GET' });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.id).toBe(testCustomerId);
          expect(data.name).toBe('山田太郎');
          expect(data.email).toBe('yamada@example.com');
          expect(data.phone).toBe('090-1234-5678');
          expect(data.address).toBe('東京都渋谷区1-2-3');
          expect(data).toHaveProperty('createdAt');
          expect(data).toHaveProperty('updatedAt');
        },
      });
    });
  });

  describe('異常系', () => {
    test('B10102-T02: 存在しない顧客ID_異常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: '99999' },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'GET' });
          const data = await res.json();

          expect(res.status).toBe(404);
          expect(data.message).toBe('顧客が見つかりません');
          expect(data.error).toBe('Not Found');
        },
      });
    });

    test('B10102-T03: 無効な顧客ID形式_異常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: 'abc' },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'GET' });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.message).toContain('無効なID形式');
          expect(data.error).toBe('Bad Request');
        },
      });
    });

    test('B10102-T04: マイナス顧客ID_異常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: '-1' },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'GET' });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.message).toContain('無効なID');
          expect(data.error).toBe('Bad Request');
        },
      });
    });
  });
});
```

---

### B10104: 顧客更新API (PUT /api/customers/[id])

#### テストケース一覧

| テストID | テスト名 | テスト区分 | 事前条件 | 入力値 | 期待結果 | HTTPステータス |
|---------|---------|-----------|---------|--------|---------|---------------|
| B10104-T01 | 顧客更新_正常系_全項目 | 正常系 | 顧客ID=1が登録済み | id=1, 有効な顧客情報(全項目) | 顧客情報が更新され、更新内容を返却 | 200 OK |
| B10104-T02 | 顧客更新_正常系_部分更新 | 正常系 | 顧客ID=1が登録済み | id=1, 有効な顧客情報(一部項目) | 指定項目のみ更新される | 200 OK |
| B10104-T03 | 存在しない顧客ID_異常系 | 異常系 | 顧客データが登録済み | id=99999, 有効な顧客情報 | エラーメッセージを返却 | 404 Not Found |
| B10104-T04 | メールアドレス形式不正_異常系 | 異常系 | 顧客ID=1が登録済み | id=1, email="invalid" | エラーメッセージを返却 | 400 Bad Request |
| B10104-T05 | 重複メールアドレス_異常系 | 異常系 | 顧客ID=1,2が登録済み | id=1, email=(顧客2のメール) | エラーメッセージを返却 | 409 Conflict |
| B10104-T06 | updatedAt自動更新確認_正常系 | 正常系 | 顧客ID=1が登録済み | id=1, 有効な顧客情報 | updatedAtが更新される | 200 OK |

#### 実装例

```typescript
describe('PUT /api/customers/[id] - B10104 顧客更新API', () => {
  let testCustomerId: number;
  let testCustomer2Id: number;

  beforeEach(async () => {
    await cleanupTestDatabase();

    const customers = await seedCustomers([
      {
        name: '山田太郎',
        email: 'yamada@example.com',
        phone: '090-1234-5678',
        address: '東京都渋谷区1-2-3',
      },
      {
        name: '佐藤花子',
        email: 'sato@example.com',
        phone: '080-9876-5432',
        address: '大阪府大阪市2-3-4',
      },
    ]);
    testCustomerId = customers[0].id;
    testCustomer2Id = customers[1].id;
  });

  describe('正常系', () => {
    test('B10104-T01: 顧客更新_正常系_全項目', async () => {
      const updateData = {
        name: '山田太郎(更新)',
        email: 'yamada.updated@example.com',
        phone: '090-9999-8888',
        address: '東京都新宿区4-5-6',
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.id).toBe(testCustomerId);
          expect(data.name).toBe(updateData.name);
          expect(data.email).toBe(updateData.email);
          expect(data.phone).toBe(updateData.phone);
          expect(data.address).toBe(updateData.address);
          expect(new Date(data.updatedAt).getTime()).toBeGreaterThan(
            new Date(data.createdAt).getTime()
          );
        },
      });
    });

    test('B10104-T02: 顧客更新_正常系_部分更新', async () => {
      const originalCustomer = await prisma.customer.findUnique({
        where: { id: testCustomerId },
      });

      const updateData = {
        phone: '080-1111-2222',
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.phone).toBe(updateData.phone);
          // 他の項目は変更されていないことを確認
          expect(data.name).toBe(originalCustomer?.name);
          expect(data.email).toBe(originalCustomer?.email);
          expect(data.address).toBe(originalCustomer?.address);
        },
      });
    });

    test('B10104-T06: updatedAt自動更新確認_正常系', async () => {
      const originalCustomer = await prisma.customer.findUnique({
        where: { id: testCustomerId },
      });

      // 1秒待機
      await new Promise((resolve) => setTimeout(resolve, 1000));

      const updateData = {
        name: '山田太郎(更新)',
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(new Date(data.updatedAt).getTime()).toBeGreaterThan(
            new Date(originalCustomer!.updatedAt).getTime()
          );
          // createdAtは変更されない
          expect(data.createdAt).toBe(originalCustomer!.createdAt.toISOString());
        },
      });
    });
  });

  describe('異常系', () => {
    test('B10104-T03: 存在しない顧客ID_異常系', async () => {
      const updateData = {
        name: '更新テスト',
        email: 'update@example.com',
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: '99999' },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(404);
          expect(data.message).toBe('顧客が見つかりません');
        },
      });
    });

    test('B10104-T04: メールアドレス形式不正_異常系', async () => {
      const updateData = {
        email: 'invalid-email',
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.errors).toContainEqual(
            expect.objectContaining({
              field: 'email',
              message: 'メールアドレスの形式が正しくありません',
            })
          );
        },
      });
    });

    test('B10104-T05: 重複メールアドレス_異常系', async () => {
      const customer2 = await prisma.customer.findUnique({
        where: { id: testCustomer2Id },
      });

      const updateData = {
        email: customer2!.email, // 顧客2のメールアドレスに更新
      };

      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();

          expect(res.status).toBe(409);
          expect(data.message).toBe('メールアドレスが既に登録されています');
          expect(data.conflictField).toBe('email');
        },
      });
    });
  });
});
```

---

### B10105: 顧客削除API (DELETE /api/customers/[id])

#### テストケース一覧

| テストID | テスト名 | テスト区分 | 事前条件 | 入力値 | 期待結果 | HTTPステータス |
|---------|---------|-----------|---------|--------|---------|---------------|
| B10105-T01 | 顧客削除_正常系 | 正常系 | 顧客ID=1が登録済み | id=1 | 顧客が削除される | 200 OK |
| B10105-T02 | 存在しない顧客ID_異常系 | 異常系 | 顧客データが登録済み | id=99999 | エラーメッセージを返却 | 404 Not Found |
| B10105-T03 | 無効な顧客ID形式_異常系 | 異常系 | 顧客データが登録済み | id=abc | エラーメッセージを返却 | 400 Bad Request |
| B10105-T04 | 削除済み顧客の再削除_異常系 | 異常系 | 顧客ID=1が削除済み | id=1 | エラーメッセージを返却 | 404 Not Found |

#### 実装例

```typescript
describe('DELETE /api/customers/[id] - B10105 顧客削除API', () => {
  let testCustomerId: number;

  beforeEach(async () => {
    await cleanupTestDatabase();

    const customers = await seedCustomers([
      {
        name: '山田太郎',
        email: 'yamada@example.com',
        phone: '090-1234-5678',
        address: '東京都渋谷区1-2-3',
      },
    ]);
    testCustomerId = customers[0].id;
  });

  describe('正常系', () => {
    test('B10105-T01: 顧客削除_正常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'DELETE' });
          const data = await res.json();

          expect(res.status).toBe(200);
          expect(data.message).toBe('顧客を削除しました');
          expect(data.deletedId).toBe(testCustomerId);

          // 削除後、データベースから消えていることを確認
          const deletedCustomer = await prisma.customer.findUnique({
            where: { id: testCustomerId },
          });
          expect(deletedCustomer).toBeNull();
        },
      });
    });
  });

  describe('異常系', () => {
    test('B10105-T02: 存在しない顧客ID_異常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: '99999' },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'DELETE' });
          const data = await res.json();

          expect(res.status).toBe(404);
          expect(data.message).toBe('顧客が見つかりません');
        },
      });
    });

    test('B10105-T03: 無効な顧客ID形式_異常系', async () => {
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: 'abc' },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'DELETE' });
          const data = await res.json();

          expect(res.status).toBe(400);
          expect(data.message).toContain('無効なID形式');
        },
      });
    });

    test('B10105-T04: 削除済み顧客の再削除_異常系', async () => {
      // 最初の削除
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          await fetch({ method: 'DELETE' });
        },
      });

      // 再度削除を試行
      await testApiHandler({
        appHandler: customerIdHandler,
        params: { id: testCustomerId.toString() },
        test: async ({ fetch }) => {
          const res = await fetch({ method: 'DELETE' });
          const data = await res.json();

          expect(res.status).toBe(404);
          expect(data.message).toBe('顧客が見つかりません');
        },
      });
    });
  });
});
```

---

## 結合テスト仕様

### 結合テストシナリオ一覧

| シナリオID | シナリオ名 | 概要 | 使用API |
|-----------|----------|------|--------|
| IT-S01 | 顧客ライフサイクル_正常系 | 顧客の登録→取得→更新→削除の一連の流れ | B10103, B10102, B10104, B10105 |
| IT-S02 | 検索とフィルタリング_正常系 | 複数顧客登録後の検索・絞り込み | B10103, B10101 |
| IT-S03 | 重複チェック_異常系 | 重複メールアドレスでの登録・更新 | B10103, B10104 |
| IT-S04 | ページネーションと並び替え | 大量データの検索とページング | B10103, B10101 |
| IT-S05 | エラーハンドリング連携 | 異常系の連続処理 | 全API |

### IT-S01: 顧客ライフサイクル_正常系

#### 実装例

**__tests__/integration/customer-lifecycle.test.ts**

```typescript
import { testApiHandler } from 'next-test-api-route-handler';
import * as customersHandler from '@/app/api/customers/route';
import * as customerIdHandler from '@/app/api/customers/[id]/route';
import { prisma } from '@/lib/prisma';
import { setupTestDatabase, cleanupTestDatabase } from '@/__tests__/utils/prisma-test-helper';

describe('IT-S01: 顧客ライフサイクル_正常系', () => {
  let customerId: number;

  beforeAll(async () => {
    await setupTestDatabase();
  });

  beforeEach(async () => {
    await cleanupTestDatabase();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  test('顧客の登録→取得→更新→削除の一連の流れ', async () => {
    // ステップ1: 新規顧客を登録
    const newCustomer = {
      name: '統合テスト太郎',
      email: 'integration.test@example.com',
      phone: '090-1111-2222',
      address: '東京都千代田区1-1-1',
    };

    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newCustomer),
        });
        const data = await res.json();

        expect(res.status).toBe(201);
        expect(data).toHaveProperty('id');
        customerId = data.id;
      },
    });

    // ステップ2: 登録した顧客の詳細を取得
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customerId.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({ method: 'GET' });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data.id).toBe(customerId);
        expect(data.name).toBe(newCustomer.name);
        expect(data.email).toBe(newCustomer.email);
      },
    });

    // ステップ3: 顧客情報を更新
    const updateData = {
      name: '統合テスト太郎(更新)',
      email: 'integration.test.updated@example.com',
      phone: '090-3333-4444',
      address: '東京都港区2-2-2',
    };

    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customerId.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData),
        });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data.name).toBe(updateData.name);
        expect(data.email).toBe(updateData.email);
      },
    });

    // ステップ4: 更新後の顧客詳細を取得
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customerId.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({ method: 'GET' });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data.name).toBe(updateData.name);
        expect(data.email).toBe(updateData.email);
      },
    });

    // ステップ5: 顧客を削除
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customerId.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({ method: 'DELETE' });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data.deletedId).toBe(customerId);
      },
    });

    // ステップ6: 削除した顧客の取得を試行
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customerId.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({ method: 'GET' });
        const data = await res.json();

        expect(res.status).toBe(404);
        expect(data.message).toBe('顧客が見つかりません');
      },
    });
  });
});
```

### IT-S02: 検索とフィルタリング_正常系

```typescript
describe('IT-S02: 検索とフィルタリング_正常系', () => {
  const testCustomers = [
    {
      name: '山田太郎',
      email: 'yamada.taro@example.com',
      phone: '090-1111-1111',
      address: '東京都渋谷区1-1-1',
    },
    {
      name: '山田花子',
      email: 'yamada.hanako@example.com',
      phone: '090-2222-2222',
      address: '東京都新宿区2-2-2',
    },
    {
      name: '佐藤一郎',
      email: 'sato.ichiro@example.com',
      phone: '090-3333-3333',
      address: '大阪府大阪市3-3-3',
    },
  ];

  beforeEach(async () => {
    await cleanupTestDatabase();
  });

  test('複数顧客の登録と様々な検索条件での取得', async () => {
    // ステップ1-3: 3件の顧客を登録
    for (const customer of testCustomers) {
      await testApiHandler({
        appHandler: customersHandler,
        test: async ({ fetch }) => {
          const res = await fetch({
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer),
          });
          expect(res.status).toBe(201);
        },
      });
    }

    // ステップ4: 全件検索
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({ method: 'GET' });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data).toHaveLength(3);
      },
    });

    // ステップ5: 名前で検索(山田)
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'GET',
          params: { name: '山田' },
        });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data).toHaveLength(2);
        expect(data.every((c: any) => c.name.includes('山田'))).toBe(true);
      },
    });

    // ステップ6: メールで検索
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'GET',
          params: { email: 'yamada.taro@example.com' },
        });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data).toHaveLength(1);
        expect(data[0].email).toBe('yamada.taro@example.com');
      },
    });

    // ステップ7: 複合条件検索
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'GET',
          params: {
            name: '山田',
            phone: '090-1111-1111',
          },
        });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data).toHaveLength(1);
        expect(data[0].name).toBe('山田太郎');
      },
    });
  });
});
```

### IT-S03: 重複チェック_異常系

```typescript
describe('IT-S03: 重複チェック_異常系', () => {
  beforeEach(async () => {
    await cleanupTestDatabase();
  });

  test('メールアドレスの一意性制約の検証', async () => {
    let customer1Id: number;
    let customer3Id: number;

    // ステップ1: 顧客Aを登録
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: '顧客A',
            email: 'test@example.com',
            phone: '090-1111-1111',
          }),
        });
        const data = await res.json();

        expect(res.status).toBe(201);
        customer1Id = data.id;
      },
    });

    // ステップ2: 同じメールアドレスで顧客Bを登録(失敗)
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: '顧客B',
            email: 'test@example.com', // 重複
            phone: '090-2222-2222',
          }),
        });
        const data = await res.json();

        expect(res.status).toBe(409);
        expect(data.message).toBe('メールアドレスが既に登録されています');
      },
    });

    // ステップ3: 顧客Cを別メールで登録(成功)
    await testApiHandler({
      appHandler: customersHandler,
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: '顧客C',
            email: 'customer-c@example.com',
            phone: '090-3333-3333',
          }),
        });
        const data = await res.json();

        expect(res.status).toBe(201);
        customer3Id = data.id;
      },
    });

    // ステップ4: 顧客Cを顧客Aと同じメールに更新(失敗)
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customer3Id.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'test@example.com', // 顧客Aのメール
          }),
        });
        const data = await res.json();

        expect(res.status).toBe(409);
        expect(data.message).toBe('メールアドレスが既に登録されています');
      },
    });

    // ステップ5: 顧客Cを別の新しいメールに更新(成功)
    await testApiHandler({
      appHandler: customerIdHandler,
      params: { id: customer3Id.toString() },
      test: async ({ fetch }) => {
        const res = await fetch({
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'customer-c-updated@example.com',
          }),
        });
        const data = await res.json();

        expect(res.status).toBe(200);
        expect(data.email).toBe('customer-c-updated@example.com');
      },
    });
  });
});
```

---

## テストデータ

### フィクスチャファイル

**__tests__/fixtures/customers.json**

```json
[
  {
    "name": "山田太郎",
    "email": "yamada.taro@example.com",
    "phone": "090-1234-5678",
    "address": "東京都渋谷区桜丘町1-2-3"
  },
  {
    "name": "佐藤花子",
    "email": "sato.hanako@example.com",
    "phone": "080-2345-6789",
    "address": "大阪府大阪市北区梅田2-3-4"
  },
  {
    "name": "田中一郎",
    "email": "tanaka.ichiro@example.com",
    "phone": "070-3456-7890",
    "address": "愛知県名古屋市中区栄3-4-5"
  },
  {
    "name": "鈴木健",
    "email": "suzuki.ken@example.com",
    "phone": "090-1111-2222",
    "address": "福岡県福岡市博多区1-1-1"
  },
  {
    "name": "鈴木美咲",
    "email": "suzuki.misaki@example.com",
    "phone": "090-2222-3333",
    "address": "福岡県福岡市博多区2-2-2"
  },
  {
    "name": "高橋誠",
    "email": "takahashi.makoto@example.com",
    "phone": "090-3333-4444",
    "address": "北海道札幌市中央区3-3-3"
  },
  {
    "name": "伊藤優子",
    "email": "ito.yuko@example.com",
    "phone": "090-4444-5555",
    "address": "宮城県仙台市青葉区4-4-4"
  },
  {
    "name": "渡辺大輔",
    "email": "watanabe.daisuke@example.com",
    "phone": "090-5555-6666",
    "address": "神奈川県横浜市西区5-5-5"
  },
  {
    "name": "顧客09_斉藤隆",
    "email": "customer09@example.com",
    "phone": "090-0009-0009",
    "address": "東京都世田谷区三軒茶屋9-9-9"
  },
  {
    "name": "顧客10_佐々木彩",
    "email": "customer10@example.com",
    "phone": "090-0010-0010",
    "address": "東京都杉並区荻窪10-10-10"
  }
]
```

**__tests__/fixtures/invalid-customers.json**

```json
{
  "invalid_email": {
    "name": "テスト太郎",
    "email": "invalid-email-format",
    "phone": "090-1234-5678",
    "address": "東京都渋谷区1-1-1"
  },
  "invalid_phone": {
    "name": "テスト花子",
    "email": "test@example.com",
    "phone": "123",
    "address": "東京都新宿区2-2-2"
  },
  "missing_required_name": {
    "email": "test@example.com",
    "phone": "090-1234-5678",
    "address": "東京都港区3-3-3"
  },
  "missing_required_email": {
    "name": "テスト一郎",
    "phone": "090-1234-5678",
    "address": "東京都中央区4-4-4"
  },
  "name_too_long": {
    "name": "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんアイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲンabcdefghijklmnopqrstuvwxyz12345",
    "email": "test@example.com",
    "phone": "090-1234-5678",
    "address": "東京都千代田区5-5-5"
  },
  "address_too_long": {
    "name": "テスト美咲",
    "email": "test@example.com",
    "phone": "090-1234-5678",
    "address": "東京都渋谷区あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんアイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲンabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん"
  }
}
```

### Prismaテストヘルパー

**__tests__/utils/prisma-test-helper.ts**

```typescript
import { PrismaClient } from '@prisma/client';

export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL_TEST || 'file:./test.db',
    },
  },
});

/**
 * テストデータベースのセットアップ
 */
export async function setupTestDatabase() {
  await prisma.$connect();

  // テーブルの作成(マイグレーション実行)
  // 実行コマンド: npx prisma migrate deploy
}

/**
 * テストデータベースのクリーンアップ
 */
export async function cleanupTestDatabase() {
  // 全テーブルのデータを削除
  await prisma.customer.deleteMany();
}

/**
 * 顧客データのシード
 */
export async function seedCustomers(customers: any[]) {
  const createdCustomers = [];

  for (const customer of customers) {
    const created = await prisma.customer.create({
      data: customer,
    });
    createdCustomers.push(created);
  }

  return createdCustomers;
}

/**
 * トランザクションでテストを実行
 */
export async function runInTransaction(callback: () => Promise<void>) {
  await prisma.$transaction(async (tx) => {
    try {
      await callback();
    } finally {
      // トランザクションは自動的にロールバックされる
      throw new Error('Rollback transaction');
    }
  }).catch(() => {
    // ロールバックエラーを無視
  });
}
```

**__tests__/utils/test-helpers.ts**

```typescript
import { mockCustomers } from '../fixtures/customers';
import { invalidCustomers } from '../fixtures/invalid-customers';

/**
 * テスト用の顧客データを取得
 */
export function getTestCustomer(index: number = 0) {
  return mockCustomers[index];
}

/**
 * テスト用の無効な顧客データを取得
 */
export function getInvalidCustomer(type: keyof typeof invalidCustomers) {
  return invalidCustomers[type];
}

/**
 * レスポンスの検証ヘルパー
 */
export function expectCustomerResponse(data: any) {
  expect(data).toHaveProperty('id');
  expect(data).toHaveProperty('name');
  expect(data).toHaveProperty('email');
  expect(data).toHaveProperty('phone');
  expect(data).toHaveProperty('address');
  expect(data).toHaveProperty('createdAt');
  expect(data).toHaveProperty('updatedAt');
}

/**
 * エラーレスポンスの検証ヘルパー
 */
export function expectErrorResponse(data: any, status: number) {
  expect(data).toHaveProperty('timestamp');
  expect(data).toHaveProperty('status');
  expect(data).toHaveProperty('error');
  expect(data).toHaveProperty('message');
  expect(data.status).toBe(status);
}

/**
 * ページネーションレスポンスの検証ヘルパー
 */
export function expectPaginationResponse(data: any) {
  expect(data).toHaveProperty('items');
  expect(data).toHaveProperty('pagination');
  expect(data.pagination).toHaveProperty('page');
  expect(data.pagination).toHaveProperty('limit');
  expect(data.pagination).toHaveProperty('total');
  expect(data.pagination).toHaveProperty('totalPages');
}
```

---

## テスト実行環境

### Jest設定ファイル

**jest.config.js**

```javascript
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  // Next.jsアプリのパス
  dir: './',
});

const customJestConfig = {
  // テスト環境
  testEnvironment: 'node',

  // セットアップファイル
  setupFilesAfterEnv: ['<rootDir>/__tests__/setup.ts'],

  // モジュールパスマッピング
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },

  // テストファイルのパターン
  testMatch: [
    '**/__tests__/**/*.test.ts',
    '**/__tests__/**/*.test.tsx',
  ],

  // カバレッジ設定
  collectCoverageFrom: [
    'src/app/api/**/*.ts',
    '!src/app/api/**/*.d.ts',
    '!src/app/api/**/route.ts', // ルートファイルは除外しない
  ],

  // カバレッジ閾値
  coverageThreshold: {
    global: {
      branches: 75,
      functions: 85,
      lines: 80,
      statements: 80,
    },
  },

  // タイムアウト設定
  testTimeout: 10000,
};

module.exports = createJestConfig(customJestConfig);
```

**__tests__/setup.ts**

```typescript
import { prisma } from '@/__tests__/utils/prisma-test-helper';

// グローバルセットアップ
beforeAll(async () => {
  // 環境変数の設定
  process.env.NODE_ENV = 'test';
  process.env.DATABASE_URL = process.env.DATABASE_URL_TEST || 'file:./test.db';
});

// グローバルクリーンアップ
afterAll(async () => {
  await prisma.$disconnect();
});

// Jestのカスタムマッチャー
expect.extend({
  toBeValidCustomer(received) {
    const requiredFields = ['id', 'name', 'email', 'createdAt', 'updatedAt'];
    const hasAllFields = requiredFields.every((field) => field in received);

    return {
      pass: hasAllFields,
      message: () =>
        hasAllFields
          ? `expected ${received} not to be a valid customer`
          : `expected ${received} to have all required fields: ${requiredFields.join(', ')}`,
    };
  },
});
```

### package.json スクリプト

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:unit": "jest --testPathPattern=__tests__/api",
    "test:integration": "jest --testPathPattern=__tests__/integration",
    "test:ci": "jest --ci --coverage --maxWorkers=2",
    "test:debug": "node --inspect-brk node_modules/.bin/jest --runInBand"
  }
}
```

### テストデータベース設定

**.env.test**

```bash
# テスト用データベースURL
DATABASE_URL_TEST="file:./test.db"

# 本番用データベースは使用しない
DATABASE_URL="file:./test.db"

# Next.js設定
NODE_ENV="test"
```

**prisma/schema.prisma (テスト用設定例)**

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"  // テストはSQLite
  url      = env("DATABASE_URL")
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### テスト実行コマンド

```bash
# 全テスト実行
npm test

# watchモードで実行
npm run test:watch

# カバレッジ付きで実行
npm run test:coverage

# 単体テストのみ実行
npm run test:unit

# 結合テストのみ実行
npm run test:integration

# CI環境での実行
npm run test:ci

# デバッグモードで実行
npm run test:debug

# 特定のテストファイルを実行
npx jest __tests__/api/customers/route.test.ts

# 特定のテストケースを実行
npx jest -t "B10101-T01"
```

---

## 期待結果定義

### HTTPステータスコード一覧

| ステータスコード | 意味 | 使用シーン |
|----------------|------|----------|
| 200 OK | リクエスト成功 | 検索成功、取得成功、更新成功、削除成功 |
| 201 Created | リソース作成成功 | 顧客登録成功 |
| 400 Bad Request | 不正なリクエスト | バリデーションエラー、パラメータ不正 |
| 404 Not Found | リソースが見つからない | 存在しない顧客ID指定 |
| 409 Conflict | リソースの競合 | メールアドレス重複 |
| 500 Internal Server Error | サーバー内部エラー | データベース接続エラー、予期しないエラー |

### レスポンス構造定義

#### 正常系レスポンス

**単一顧客取得/登録/更新**

```typescript
interface CustomerResponse {
  id: number;
  name: string;
  email: string;
  phone: string | null;
  address: string | null;
  createdAt: string;  // ISO 8601形式
  updatedAt: string;  // ISO 8601形式
}
```

**複数顧客検索(ページネーションなし)**

```typescript
type CustomersResponse = CustomerResponse[];
```

**複数顧客検索(ページネーションあり)**

```typescript
interface PaginatedCustomersResponse {
  items: CustomerResponse[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

**削除成功**

```typescript
interface DeleteResponse {
  message: string;
  deletedId: number;
}
```

#### 異常系レスポンス

**バリデーションエラー (400)**

```typescript
interface ValidationErrorResponse {
  timestamp: string;
  status: 400;
  error: "Bad Request";
  message: string;
  errors: Array<{
    field: string;
    rejectedValue: any;
    message: string;
  }>;
  path: string;
}
```

**リソース不存在 (404)**

```typescript
interface NotFoundErrorResponse {
  timestamp: string;
  status: 404;
  error: "Not Found";
  message: string;
  path: string;
}
```

**リソース競合 (409)**

```typescript
interface ConflictErrorResponse {
  timestamp: string;
  status: 409;
  error: "Conflict";
  message: string;
  conflictField: string;
  conflictValue: string;
  path: string;
}
```

**サーバーエラー (500)**

```typescript
interface ServerErrorResponse {
  timestamp: string;
  status: 500;
  error: "Internal Server Error";
  message: string;
  path: string;
}
```

---

## 補足事項

### テスト実装時の注意点

1. **テストデータのクリーンアップ**
   - 各テストメソッド実行前にデータベースをクリーンアップする
   - `beforeEach`でクリーンアップ処理を実行
   - テスト間のデータ干渉を防ぐ

2. **テストの独立性**
   - 各テストは他のテストに依存せず、独立して実行可能であること
   - テストの実行順序に依存しない設計
   - 並列実行可能な設計を心がける

3. **Next.js App Router特有の考慮事項**
   - `next-test-api-route-handler`を使用してRoute Handlerをテスト
   - `testApiHandler`関数で実際のHTTPリクエストをシミュレート
   - Dynamic Routeのパラメータは`params`で指定

4. **Prismaのテスト戦略**
   - テスト用データベース(SQLite)を使用
   - 各テスト後にデータをクリーンアップ
   - トランザクションを活用した分離

5. **エラーメッセージの検証**
   - HTTPステータスコードだけでなく、エラーメッセージの内容も検証
   - 日本語メッセージの正確性を確認
   - エラーレスポンスの構造を統一

6. **非同期処理のテスト**
   - `async/await`を適切に使用
   - Promiseの解決を待つ
   - タイムアウト設定を適切に行う

### カバレッジ目標

| レベル | 目標カバレッジ |
|--------|--------------|
| ライン(Line) | 80%以上 |
| ブランチ(Branch) | 75%以上 |
| 関数(Function) | 85%以上 |
| ステートメント(Statement) | 80%以上 |

### CI/CD統合

**GitHub Actions設定例 (.github/workflows/test.yml)**

```yaml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: file:./test.db

      - name: Run tests
        run: npm run test:ci

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
```

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2025-11-27 | 初版作成(Spring Boot版) | - |
| 2.0 | 2025-11-27 | Next.js App Router + Jest/Supertestに変換 | - |
