# ファイルIF設計書

## 文書管理情報

| 項目 | 内容 |
|------|------|
| 文書ID | A1-IF-001 |
| システム名 | A1 プロジェクト管理システム |
| 文書名 | ファイルIF設計書 (Next.js版) |
| 作成日 | 2025-11-27 |
| バージョン | 2.0 |
| フレームワーク | Next.js 14+ (App Router) |

---

## 目次

1. [仕様概要](#仕様概要)
2. [ファイルインターフェース一覧](#ファイルインターフェース一覧)
3. [アップロード設計](#アップロード設計)
4. [ダウンロード設計](#ダウンロード設計)
5. [レイアウト定義](#レイアウト定義)
6. [実装例](#実装例)
7. [運用に関する注意事項](#運用に関する注意事項)

---

## 仕様概要

### 目的

本文書は、Next.js App Routerを使用したA1プロジェクト管理システムにおけるファイルインターフェース(IF)の仕様を定義する。
CSVファイルのアップロード・ダウンロード機能の実装方法、データバリデーション、エラーハンドリングを明確化する。

### 対象範囲

- **アップロード**: プロジェクト情報CSV一括登録
- **ダウンロード**: プロジェクト一覧CSV出力、ユーザ別従事プロジェクト一覧CSV出力

### 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js 14+ (App Router) |
| 言語 | TypeScript 5.0+ |
| バリデーション | Zod |
| CSVパース | papaparse |
| CSVビルド | json2csv / papaparse |
| ファイル処理 | Node.js File API, FormData |
| ストレージ | ローカルファイルシステム / S3 (オプション) |

### ファイル形式共通仕様

| 項目 | 仕様 |
|------|------|
| ファイル形式 | CSV (Comma Separated Values) |
| 文字コード | UTF-8 (BOM付き) |
| 改行コード | CRLF (Windows形式) / LF (Unix形式) 両対応 |
| 区切り文字 | カンマ (,) |
| 囲み文字 | ダブルクォーテーション (") ※カンマ・改行含む場合 |
| ヘッダー行 | あり (1行目) |
| 日付形式 | YYYY-MM-DD |
| 数値形式 | カンマ区切りなし |
| 最大ファイルサイズ | 10MB (アップロード) |

---

## ファイルインターフェース一覧

### アップロード (入力)

| インターフェースID | ファイル名 | 説明 | API Route | 関連機能 |
|-------------------|----------|------|----------|---------|
| IF-UPLOAD-001 | project_bulk_import.csv | プロジェクト一括登録 | `/api/projects/upload` | BA1060201 |

### ダウンロード (出力)

| インターフェースID | ファイル名 | 説明 | API Route | 関連機能 |
|-------------------|----------|------|----------|---------|
| IF-DOWNLOAD-001 | project_list_YYYYMMDD.csv | 期間内プロジェクト一覧 | `/api/projects/download` | BA1060101 |
| IF-DOWNLOAD-002 | user_project_list_YYYYMMDD.csv | ユーザ別従事プロジェクト一覧 | `/api/projects/download/user-projects` | BA1060301 |

**ファイル名命名規則**:
- `YYYYMMDD`: 出力日付 (例: 20251127)
- アップロードファイルは任意のファイル名を許容

---

## アップロード設計

### アーキテクチャ

```
┌─────────────┐     FormData      ┌──────────────────┐
│   Client    │ ────────────────> │  Server Action   │
│  Component  │                    │  or API Route    │
└─────────────┘                    └──────────────────┘
                                            │
                                            ▼
                                   ┌──────────────────┐
                                   │  File Validation │
                                   │      (Zod)       │
                                   └──────────────────┘
                                            │
                                            ▼
                                   ┌──────────────────┐
                                   │   CSV Parsing    │
                                   │   (papaparse)    │
                                   └──────────────────┘
                                            │
                                            ▼
                                   ┌──────────────────┐
                                   │ Row Validation   │
                                   │      (Zod)       │
                                   └──────────────────┘
                                            │
                                            ▼
                                   ┌──────────────────┐
                                   │  Database Insert │
                                   │  (Transaction)   │
                                   └──────────────────┘
```

### API Route実装

**エンドポイント**: `POST /api/projects/upload`

```typescript
// app/api/projects/upload/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { uploadProjectsCsv } from '@/lib/services/project-upload.service';

export const config = {
  api: {
    bodyParser: false, // FormDataを手動で処理
  },
};

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json(
        { error: 'ファイルが選択されていません' },
        { status: 400 }
      );
    }

    const result = await uploadProjectsCsv(file);

    return NextResponse.json(result, { status: 200 });
  } catch (error) {
    console.error('CSV upload error:', error);
    return NextResponse.json(
      { error: 'ファイルのアップロード中にエラーが発生しました' },
      { status: 500 }
    );
  }
}
```

### Server Action実装 (推奨)

```typescript
// app/actions/project-upload.actions.ts
'use server';

import { uploadProjectsCsv } from '@/lib/services/project-upload.service';

export async function uploadProjectsCsvAction(formData: FormData) {
  const file = formData.get('file') as File;

  if (!file) {
    return {
      success: false,
      error: 'ファイルが選択されていません',
    };
  }

  try {
    const result = await uploadProjectsCsv(file);
    return {
      success: true,
      data: result,
    };
  } catch (error) {
    console.error('CSV upload error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : '予期しないエラーが発生しました',
    };
  }
}
```

### ファイルバリデーション

```typescript
// lib/validations/file.validation.ts
import { z } from 'zod';

// ファイルバリデーションスキーマ
export const fileUploadSchema = z.object({
  file: z
    .instanceof(File)
    .refine((file) => file.size <= 10 * 1024 * 1024, {
      message: 'ファイルサイズは10MB以下にしてください',
    })
    .refine((file) => file.type === 'text/csv' || file.name.endsWith('.csv'), {
      message: 'CSVファイルを選択してください',
    })
    .refine((file) => file.size > 0, {
      message: '空のファイルはアップロードできません',
    }),
});

// バリデーション実行
export function validateFileUpload(file: File) {
  return fileUploadSchema.shape.file.safeParse(file);
}
```

### CSV処理サービス

```typescript
// lib/services/project-upload.service.ts
import Papa from 'papaparse';
import { projectBulkImportSchema, type ProjectBulkImportRow } from '@/lib/validations/project.validation';
import { db } from '@/lib/db';
import { projects } from '@/lib/db/schema';

export interface UploadResult {
  totalRows: number;
  successCount: number;
  errorCount: number;
  errors: Array<{
    row: number;
    field?: string;
    message: string;
  }>;
}

export async function uploadProjectsCsv(file: File): Promise<UploadResult> {
  // 1. ファイルをテキストとして読み込み
  const text = await file.text();

  // 2. BOM除去
  const cleanedText = text.replace(/^\uFEFF/, '');

  // 3. CSV解析
  const parseResult = await new Promise<Papa.ParseResult<unknown>>((resolve) => {
    Papa.parse(cleanedText, {
      header: true,
      skipEmptyLines: true,
      complete: resolve,
    });
  });

  if (parseResult.errors.length > 0) {
    throw new Error(`CSV解析エラー: ${parseResult.errors[0].message}`);
  }

  const rows = parseResult.data;
  const result: UploadResult = {
    totalRows: rows.length,
    successCount: 0,
    errorCount: 0,
    errors: [],
  };

  // 4. バリデーション
  const validatedRows: ProjectBulkImportRow[] = [];

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const validation = projectBulkImportSchema.safeParse(row);

    if (!validation.success) {
      result.errorCount++;
      validation.error.errors.forEach((err) => {
        result.errors.push({
          row: i + 2, // ヘッダー行を考慮
          field: err.path.join('.'),
          message: err.message,
        });
      });
    } else {
      validatedRows.push(validation.data);
    }
  }

  // エラーがある場合は登録処理をスキップ
  if (result.errorCount > 0) {
    return result;
  }

  // 5. データベースへの一括登録 (トランザクション)
  try {
    await db.transaction(async (tx) => {
      for (const row of validatedRows) {
        await tx.insert(projects).values({
          projectId: row.project_id,
          projectName: row.project_name,
          projectType: row.project_type,
          startDate: new Date(row.start_date),
          endDate: new Date(row.end_date),
          managerId: row.manager_id,
          budget: row.budget,
          status: row.status,
          description: row.description || null,
          createdAt: new Date(),
          updatedAt: new Date(),
        });
      }
    });

    result.successCount = validatedRows.length;
  } catch (error) {
    throw new Error('データベース登録中にエラーが発生しました');
  }

  return result;
}
```

### クライアントコンポーネント

```typescript
// app/projects/upload/page.tsx
'use client';

import { useState } from 'react';
import { uploadProjectsCsvAction } from '@/app/actions/project-upload.actions';

export default function ProjectUploadPage() {
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [result, setResult] = useState<any>(null);

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (!file) return;

    setUploading(true);

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await uploadProjectsCsvAction(formData);
      setResult(response);
    } catch (error) {
      console.error('Upload error:', error);
    } finally {
      setUploading(false);
    }
  };

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">プロジェクト一括登録</h1>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="file" className="block text-sm font-medium mb-2">
            CSVファイル
          </label>
          <input
            type="file"
            id="file"
            accept=".csv"
            onChange={(e) => setFile(e.target.files?.[0] || null)}
            className="block w-full border border-gray-300 rounded-md p-2"
            disabled={uploading}
          />
          <p className="text-sm text-gray-500 mt-1">
            最大10MB、UTF-8エンコード
          </p>
        </div>

        <button
          type="submit"
          disabled={!file || uploading}
          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50"
        >
          {uploading ? 'アップロード中...' : 'アップロード'}
        </button>
      </form>

      {result && (
        <div className="mt-6">
          {result.success ? (
            <div className="bg-green-50 border border-green-200 rounded-md p-4">
              <h2 className="text-green-800 font-semibold">アップロード成功</h2>
              <p className="text-green-700 mt-2">
                {result.data.successCount}件のプロジェクトを登録しました
              </p>
            </div>
          ) : (
            <div className="bg-red-50 border border-red-200 rounded-md p-4">
              <h2 className="text-red-800 font-semibold">エラー</h2>
              <p className="text-red-700 mt-2">{result.error}</p>

              {result.data?.errors && result.data.errors.length > 0 && (
                <div className="mt-4">
                  <h3 className="text-sm font-semibold text-red-800">
                    エラー詳細 ({result.data.errorCount}件)
                  </h3>
                  <ul className="mt-2 space-y-1 text-sm text-red-700">
                    {result.data.errors.slice(0, 10).map((err: any, idx: number) => (
                      <li key={idx}>
                        行{err.row}: {err.field && `${err.field} - `}{err.message}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

---

## ダウンロード設計

### アーキテクチャ

```
┌─────────────┐     Request       ┌──────────────────┐
│   Client    │ ────────────────> │   API Route      │
│  Component  │                    │                  │
└─────────────┘                    └──────────────────┘
       │                                    │
       │                                    ▼
       │                           ┌──────────────────┐
       │                           │  Database Query  │
       │                           └──────────────────┘
       │                                    │
       │                                    ▼
       │                           ┌──────────────────┐
       │                           │   Data Format    │
       │                           │  (CSV Builder)   │
       │                           └──────────────────┘
       │                                    │
       │    Streaming Response              ▼
       │ <──────────────────────   ┌──────────────────┐
       │                           │  Content-Disp.   │
       └───────────────────────────│  Response Header │
                                   └──────────────────┘
```

### API Route実装

```typescript
// app/api/projects/download/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { downloadProjectsCsv } from '@/lib/services/project-download.service';
import { format } from 'date-fns';

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const startDate = searchParams.get('startDate');
    const endDate = searchParams.get('endDate');

    // CSV生成
    const csvContent = await downloadProjectsCsv({
      startDate: startDate ? new Date(startDate) : undefined,
      endDate: endDate ? new Date(endDate) : undefined,
    });

    // ファイル名生成
    const fileName = `project_list_${format(new Date(), 'yyyyMMdd')}.csv`;

    // レスポンスヘッダー設定
    const headers = new Headers();
    headers.set('Content-Type', 'text/csv; charset=utf-8');
    headers.set('Content-Disposition', `attachment; filename="${fileName}"`);

    // BOM付きUTF-8として返却
    const bom = '\uFEFF';
    const csvWithBom = bom + csvContent;

    return new NextResponse(csvWithBom, {
      status: 200,
      headers,
    });
  } catch (error) {
    console.error('CSV download error:', error);
    return NextResponse.json(
      { error: 'ファイルのダウンロード中にエラーが発生しました' },
      { status: 500 }
    );
  }
}
```

### Streaming Response対応

```typescript
// app/api/projects/download/stream/route.ts
import { NextRequest } from 'next/server';
import { streamProjectsCsv } from '@/lib/services/project-download.service';
import { format } from 'date-fns';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const startDate = searchParams.get('startDate');
  const endDate = searchParams.get('endDate');

  const fileName = `project_list_${format(new Date(), 'yyyyMMdd')}.csv`;

  // ReadableStreamを生成
  const stream = new ReadableStream({
    async start(controller) {
      try {
        // BOM送信
        controller.enqueue(new TextEncoder().encode('\uFEFF'));

        // CSVヘッダー送信
        const header = 'project_id,project_name,project_type,...\r\n';
        controller.enqueue(new TextEncoder().encode(header));

        // データを行ごとにストリーミング
        await streamProjectsCsv(
          {
            startDate: startDate ? new Date(startDate) : undefined,
            endDate: endDate ? new Date(endDate) : undefined,
          },
          (row) => {
            const csvRow = `${row.project_id},${row.project_name},...\r\n`;
            controller.enqueue(new TextEncoder().encode(csvRow));
          }
        );

        controller.close();
      } catch (error) {
        controller.error(error);
      }
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/csv; charset=utf-8',
      'Content-Disposition': `attachment; filename="${fileName}"`,
      'Transfer-Encoding': 'chunked',
    },
  });
}
```

### CSV生成サービス

```typescript
// lib/services/project-download.service.ts
import Papa from 'papaparse';
import { db } from '@/lib/db';
import { projects, users } from '@/lib/db/schema';
import { eq, and, gte, lte } from 'drizzle-orm';

export interface DownloadOptions {
  startDate?: Date;
  endDate?: Date;
}

export async function downloadProjectsCsv(options: DownloadOptions = {}): Promise<string> {
  // 1. データベースクエリ
  const conditions = [];

  if (options.startDate) {
    conditions.push(gte(projects.startDate, options.startDate));
  }

  if (options.endDate) {
    conditions.push(lte(projects.endDate, options.endDate));
  }

  const data = await db
    .select({
      project_id: projects.projectId,
      project_name: projects.projectName,
      project_type: projects.projectType,
      project_type_name: projects.projectTypeName,
      start_date: projects.startDate,
      end_date: projects.endDate,
      manager_id: projects.managerId,
      manager_name: users.userName,
      budget: projects.budget,
      actual_cost: projects.actualCost,
      progress_rate: projects.progressRate,
      status: projects.status,
      status_name: projects.statusName,
      member_count: projects.memberCount,
      description: projects.description,
      created_at: projects.createdAt,
      updated_at: projects.updatedAt,
    })
    .from(projects)
    .leftJoin(users, eq(projects.managerId, users.userId))
    .where(conditions.length > 0 ? and(...conditions) : undefined)
    .orderBy(projects.startDate);

  // 2. 日付フォーマット変換
  const formattedData = data.map((row) => ({
    ...row,
    start_date: row.start_date?.toISOString().split('T')[0],
    end_date: row.end_date?.toISOString().split('T')[0],
    created_at: row.created_at?.toISOString().replace('T', ' ').split('.')[0],
    updated_at: row.updated_at?.toISOString().replace('T', ' ').split('.')[0],
  }));

  // 3. CSV変換
  const csv = Papa.unparse(formattedData, {
    header: true,
    newline: '\r\n',
  });

  return csv;
}

// Streaming対応版
export async function streamProjectsCsv(
  options: DownloadOptions,
  onRow: (row: any) => void
): Promise<void> {
  // バッチサイズ500件で分割処理
  const batchSize = 500;
  let offset = 0;

  while (true) {
    const batch = await db
      .select()
      .from(projects)
      .limit(batchSize)
      .offset(offset);

    if (batch.length === 0) break;

    for (const row of batch) {
      onRow(row);
    }

    offset += batchSize;

    if (batch.length < batchSize) break;
  }
}
```

### クライアントコンポーネント

```typescript
// components/ProjectDownloadButton.tsx
'use client';

import { useState } from 'react';
import { format } from 'date-fns';

interface ProjectDownloadButtonProps {
  startDate?: Date;
  endDate?: Date;
}

export function ProjectDownloadButton({ startDate, endDate }: ProjectDownloadButtonProps) {
  const [downloading, setDownloading] = useState(false);

  const handleDownload = async () => {
    setDownloading(true);

    try {
      const params = new URLSearchParams();

      if (startDate) {
        params.append('startDate', format(startDate, 'yyyy-MM-dd'));
      }

      if (endDate) {
        params.append('endDate', format(endDate, 'yyyy-MM-dd'));
      }

      const response = await fetch(`/api/projects/download?${params.toString()}`);

      if (!response.ok) {
        throw new Error('ダウンロードに失敗しました');
      }

      // Blob作成とダウンロード
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `project_list_${format(new Date(), 'yyyyMMdd')}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (error) {
      console.error('Download error:', error);
      alert('ダウンロード中にエラーが発生しました');
    } finally {
      setDownloading(false);
    }
  };

  return (
    <button
      onClick={handleDownload}
      disabled={downloading}
      className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50"
    >
      {downloading ? 'ダウンロード中...' : 'CSV出力'}
    </button>
  );
}
```

---

## レイアウト定義

### IF-UPLOAD-001: プロジェクト一括登録

#### TypeScript型定義

```typescript
// lib/types/project.types.ts
export interface ProjectBulkImportRow {
  project_id: string;
  project_name: string;
  project_type: '01' | '02' | '03';
  start_date: string;
  end_date: string;
  manager_id: string;
  budget: number;
  status: '01' | '02' | '03' | '04';
  description?: string;
}

export const PROJECT_TYPES = {
  '01': '新規開発',
  '02': '保守',
  '03': '改修',
} as const;

export const PROJECT_STATUSES = {
  '01': '計画中',
  '02': '実行中',
  '03': '完了',
  '04': '中断',
} as const;
```

#### Zodバリデーションスキーマ

```typescript
// lib/validations/project.validation.ts
import { z } from 'zod';

export const projectBulkImportSchema = z.object({
  project_id: z
    .string()
    .regex(/^[A-Z0-9]{10}$/, 'プロジェクトIDは英数字10桁で入力してください')
    .min(1, 'プロジェクトIDは必須です'),

  project_name: z
    .string()
    .min(1, 'プロジェクト名は必須です')
    .max(200, 'プロジェクト名は200文字以内で入力してください'),

  project_type: z
    .enum(['01', '02', '03'], {
      errorMap: () => ({ message: 'プロジェクト種別は01, 02, 03のいずれかを指定してください' }),
    }),

  start_date: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, '開始日はYYYY-MM-DD形式で入力してください')
    .refine((date) => !isNaN(Date.parse(date)), '有効な日付を入力してください'),

  end_date: z
    .string()
    .regex(/^\d{4}-\d{2}-\d{2}$/, '終了日はYYYY-MM-DD形式で入力してください')
    .refine((date) => !isNaN(Date.parse(date)), '有効な日付を入力してください'),

  manager_id: z
    .string()
    .regex(/^[A-Z0-9]{10}$/, '管理者IDは英数字10桁で入力してください'),

  budget: z
    .number()
    .min(0, '予算は0以上で入力してください')
    .max(999999999999, '予算は999,999,999,999以下で入力してください')
    .or(
      z.string().transform((val) => {
        const num = parseFloat(val);
        if (isNaN(num)) throw new Error('予算は数値で入力してください');
        return num;
      })
    ),

  status: z
    .enum(['01', '02', '03', '04'], {
      errorMap: () => ({ message: 'ステータスは01, 02, 03, 04のいずれかを指定してください' }),
    }),

  description: z
    .string()
    .max(1000, '概要は1000文字以内で入力してください')
    .optional()
    .or(z.literal('')),
}).refine(
  (data) => {
    const start = new Date(data.start_date);
    const end = new Date(data.end_date);
    return start <= end;
  },
  {
    message: '終了日は開始日以降を指定してください',
    path: ['end_date'],
  }
);

export type ProjectBulkImportRow = z.infer<typeof projectBulkImportSchema>;
```

#### CSVレイアウト

| No | カラム名 | 論理名 | 型 | 必須 | 説明 |
|----|---------|--------|-----|------|------|
| 1 | project_id | プロジェクトID | string | ○ | 英数字10桁 |
| 2 | project_name | プロジェクト名 | string | ○ | 最大200文字 |
| 3 | project_type | プロジェクト種別 | enum | ○ | 01/02/03 |
| 4 | start_date | 開始日 | date | ○ | YYYY-MM-DD |
| 5 | end_date | 終了予定日 | date | ○ | YYYY-MM-DD |
| 6 | manager_id | 管理者ID | string | ○ | 英数字10桁 |
| 7 | budget | 予算 | number | ○ | 0以上 |
| 8 | status | ステータス | enum | ○ | 01/02/03/04 |
| 9 | description | 概要 | string | △ | 最大1000文字 |

#### サンプルCSV

```csv
project_id,project_name,project_type,start_date,end_date,manager_id,budget,status,description
PJ00000010,新会計システム導入,01,2025-04-01,2026-03-31,U000000001,80000000,01,新会計システムの導入プロジェクト
PJ00000011,社内ポータル保守,02,2025-01-01,2025-12-31,U000000005,6000000,02,社内ポータルサイトの保守業務
PJ00000012,営業支援ツール改修,03,2025-07-01,2025-09-30,U000000003,12000000,01,営業支援ツールの機能改修
```

### IF-DOWNLOAD-001: 期間内プロジェクト一覧

#### TypeScript型定義

```typescript
// lib/types/project-list.types.ts
export interface ProjectListRow {
  project_id: string;
  project_name: string;
  project_type: string;
  project_type_name: string;
  start_date: string;
  end_date: string;
  manager_id: string;
  manager_name: string;
  budget: number;
  actual_cost: number | null;
  progress_rate: number | null;
  status: string;
  status_name: string;
  member_count: number | null;
  description: string | null;
  created_at: string;
  updated_at: string;
}
```

#### CSVレイアウト

| No | カラム名 | 論理名 | 型 | 説明 |
|----|---------|--------|-----|------|
| 1 | project_id | プロジェクトID | string | |
| 2 | project_name | プロジェクト名 | string | |
| 3 | project_type | プロジェクト種別 | string | コード値 |
| 4 | project_type_name | プロジェクト種別名 | string | 表示名 |
| 5 | start_date | 開始日 | date | YYYY-MM-DD |
| 6 | end_date | 終了予定日 | date | YYYY-MM-DD |
| 7 | manager_id | 管理者ID | string | |
| 8 | manager_name | 管理者名 | string | |
| 9 | budget | 予算 | number | |
| 10 | actual_cost | 実績コスト | number | NULL可 |
| 11 | progress_rate | 進捗率 | number | 0.00-100.00 |
| 12 | status | ステータス | string | コード値 |
| 13 | status_name | ステータス名 | string | 表示名 |
| 14 | member_count | メンバー数 | number | NULL可 |
| 15 | description | 概要 | string | NULL可 |
| 16 | created_at | 作成日時 | datetime | YYYY-MM-DD HH:MI:SS |
| 17 | updated_at | 更新日時 | datetime | YYYY-MM-DD HH:MI:SS |

### IF-DOWNLOAD-002: ユーザ別従事プロジェクト一覧

#### TypeScript型定義

```typescript
// lib/types/user-project-list.types.ts
export interface UserProjectListRow {
  user_id: string;
  user_name: string;
  department_name: string | null;
  project_id: string;
  project_name: string;
  project_type: string;
  project_type_name: string;
  role: string;
  role_name: string;
  allocation_rate: number;
  start_date: string;
  end_date: string | null;
  project_start_date: string;
  project_end_date: string;
  project_status: string;
  project_status_name: string;
  assigned_at: string;
}
```

#### CSVレイアウト

| No | カラム名 | 論理名 | 型 | 説明 |
|----|---------|--------|-----|------|
| 1 | user_id | ユーザID | string | |
| 2 | user_name | ユーザ名 | string | |
| 3 | department_name | 部署名 | string | NULL可 |
| 4 | project_id | プロジェクトID | string | |
| 5 | project_name | プロジェクト名 | string | |
| 6 | project_type | プロジェクト種別 | string | |
| 7 | project_type_name | プロジェクト種別名 | string | |
| 8 | role | ロール | string | 01:PM, 02:PL, 03:メンバー |
| 9 | role_name | ロール名 | string | |
| 10 | allocation_rate | アサイン率 | number | 0.00-100.00 |
| 11 | start_date | 参画開始日 | date | YYYY-MM-DD |
| 12 | end_date | 参画終了日 | date | YYYY-MM-DD, NULL可 |
| 13 | project_start_date | プロジェクト開始日 | date | YYYY-MM-DD |
| 14 | project_end_date | プロジェクト終了日 | date | YYYY-MM-DD |
| 15 | project_status | プロジェクトステータス | string | |
| 16 | project_status_name | プロジェクトステータス名 | string | |
| 17 | assigned_at | アサイン日時 | datetime | YYYY-MM-DD HH:MI:SS |

---

## 実装例

### 完全なアップロード実装例

```typescript
// app/projects/upload/page.tsx
'use client';

import { useState } from 'react';
import { uploadProjectsCsvAction } from '@/app/actions/project-upload.actions';
import { validateFileUpload } from '@/lib/validations/file.validation';

export default function ProjectUploadPage() {
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [result, setResult] = useState<any>(null);
  const [validationError, setValidationError] = useState<string | null>(null);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];

    if (!selectedFile) {
      setFile(null);
      setValidationError(null);
      return;
    }

    // クライアント側バリデーション
    const validation = validateFileUpload(selectedFile);

    if (!validation.success) {
      setValidationError(validation.error.errors[0].message);
      setFile(null);
      return;
    }

    setFile(selectedFile);
    setValidationError(null);
    setResult(null);
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (!file) return;

    setUploading(true);
    setResult(null);

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await uploadProjectsCsvAction(formData);
      setResult(response);

      if (response.success) {
        setFile(null);
        // ファイル入力をリセット
        const fileInput = document.getElementById('file') as HTMLInputElement;
        if (fileInput) fileInput.value = '';
      }
    } catch (error) {
      console.error('Upload error:', error);
      setResult({
        success: false,
        error: 'アップロード中に予期しないエラーが発生しました',
      });
    } finally {
      setUploading(false);
    }
  };

  return (
    <div className="container mx-auto max-w-4xl p-6">
      <div className="bg-white rounded-lg shadow-md p-6">
        <h1 className="text-2xl font-bold text-gray-900 mb-2">
          プロジェクト一括登録
        </h1>
        <p className="text-gray-600 mb-6">
          CSVファイルからプロジェクト情報を一括登録します
        </p>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label
              htmlFor="file"
              className="block text-sm font-medium text-gray-700 mb-2"
            >
              CSVファイル選択
            </label>
            <input
              type="file"
              id="file"
              accept=".csv"
              onChange={handleFileChange}
              className="block w-full border border-gray-300 rounded-md p-2 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
              disabled={uploading}
            />

            {validationError && (
              <p className="mt-2 text-sm text-red-600">{validationError}</p>
            )}

            <div className="mt-2 text-sm text-gray-500 space-y-1">
              <p>• 最大ファイルサイズ: 10MB</p>
              <p>• 文字コード: UTF-8</p>
              <p>• 最大レコード数: 1,000件</p>
            </div>
          </div>

          <div className="flex items-center gap-4">
            <button
              type="submit"
              disabled={!file || uploading}
              className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {uploading ? (
                <span className="flex items-center gap-2">
                  <svg
                    className="animate-spin h-5 w-5"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      className="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      strokeWidth="4"
                    />
                    <path
                      className="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    />
                  </svg>
                  アップロード中...
                </span>
              ) : (
                'アップロード'
              )}
            </button>

            {file && !uploading && (
              <button
                type="button"
                onClick={() => {
                  setFile(null);
                  setResult(null);
                  const fileInput = document.getElementById('file') as HTMLInputElement;
                  if (fileInput) fileInput.value = '';
                }}
                className="text-gray-600 hover:text-gray-800"
              >
                キャンセル
              </button>
            )}
          </div>
        </form>

        {result && (
          <div className="mt-6">
            {result.success ? (
              <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                <div className="flex items-start">
                  <div className="flex-shrink-0">
                    <svg
                      className="h-6 w-6 text-green-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                  </div>
                  <div className="ml-3">
                    <h3 className="text-sm font-medium text-green-800">
                      アップロード成功
                    </h3>
                    <div className="mt-2 text-sm text-green-700">
                      <p>
                        {result.data.successCount}件のプロジェクトを登録しました
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <div className="flex items-start">
                  <div className="flex-shrink-0">
                    <svg
                      className="h-6 w-6 text-red-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </div>
                  <div className="ml-3 flex-1">
                    <h3 className="text-sm font-medium text-red-800">
                      エラーが発生しました
                    </h3>
                    <div className="mt-2 text-sm text-red-700">
                      <p>{result.error}</p>
                    </div>

                    {result.data?.errors && result.data.errors.length > 0 && (
                      <div className="mt-4">
                        <h4 className="text-sm font-semibold text-red-800 mb-2">
                          エラー詳細 ({result.data.errorCount}件)
                        </h4>
                        <div className="bg-white border border-red-200 rounded-md p-3 max-h-64 overflow-y-auto">
                          <ul className="space-y-2 text-sm text-red-700">
                            {result.data.errors.map((err: any, idx: number) => (
                              <li key={idx} className="flex gap-2">
                                <span className="font-semibold">行{err.row}:</span>
                                <span>
                                  {err.field && <span className="text-red-800">{err.field} - </span>}
                                  {err.message}
                                </span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      <div className="mt-8 bg-gray-50 rounded-lg p-6">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">
          CSVフォーマット
        </h2>

        <div className="bg-white border border-gray-200 rounded-md p-4 overflow-x-auto">
          <pre className="text-xs text-gray-700">
{`project_id,project_name,project_type,start_date,end_date,manager_id,budget,status,description
PJ00000010,新会計システム導入,01,2025-04-01,2026-03-31,U000000001,80000000,01,新会計システムの導入プロジェクト
PJ00000011,社内ポータル保守,02,2025-01-01,2025-12-31,U000000005,6000000,02,社内ポータルサイトの保守業務`}
          </pre>
        </div>

        <div className="mt-4 space-y-2 text-sm text-gray-600">
          <p><strong>project_type:</strong> 01=新規開発, 02=保守, 03=改修</p>
          <p><strong>status:</strong> 01=計画中, 02=実行中, 03=完了, 04=中断</p>
          <p><strong>日付形式:</strong> YYYY-MM-DD (例: 2025-04-01)</p>
        </div>
      </div>
    </div>
  );
}
```

### 完全なダウンロード実装例

```typescript
// components/ProjectListDownload.tsx
'use client';

import { useState } from 'react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';

interface ProjectListDownloadProps {
  defaultStartDate?: Date;
  defaultEndDate?: Date;
}

export function ProjectListDownload({
  defaultStartDate,
  defaultEndDate,
}: ProjectListDownloadProps) {
  const [startDate, setStartDate] = useState<string>(
    defaultStartDate ? format(defaultStartDate, 'yyyy-MM-dd') : ''
  );
  const [endDate, setEndDate] = useState<string>(
    defaultEndDate ? format(defaultEndDate, 'yyyy-MM-dd') : ''
  );
  const [downloading, setDownloading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleDownload = async () => {
    setDownloading(true);
    setError(null);

    try {
      const params = new URLSearchParams();

      if (startDate) {
        params.append('startDate', startDate);
      }

      if (endDate) {
        params.append('endDate', endDate);
      }

      const response = await fetch(`/api/projects/download?${params.toString()}`);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ダウンロードに失敗しました');
      }

      // Blob作成
      const blob = await response.blob();

      // ダウンロード実行
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `project_list_${format(new Date(), 'yyyyMMdd')}.csv`;
      document.body.appendChild(a);
      a.click();

      // クリーンアップ
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (err) {
      console.error('Download error:', err);
      setError(err instanceof Error ? err.message : 'ダウンロード中にエラーが発生しました');
    } finally {
      setDownloading(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6">
      <h2 className="text-xl font-bold text-gray-900 mb-4">
        プロジェクト一覧CSV出力
      </h2>

      <div className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              htmlFor="startDate"
              className="block text-sm font-medium text-gray-700 mb-2"
            >
              開始日
            </label>
            <input
              type="date"
              id="startDate"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
              disabled={downloading}
            />
          </div>

          <div>
            <label
              htmlFor="endDate"
              className="block text-sm font-medium text-gray-700 mb-2"
            >
              終了日
            </label>
            <input
              type="date"
              id="endDate"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
              disabled={downloading}
            />
          </div>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 rounded-md p-3">
            <p className="text-sm text-red-700">{error}</p>
          </div>
        )}

        <button
          onClick={handleDownload}
          disabled={downloading}
          className="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
        >
          {downloading ? (
            <span className="flex items-center justify-center gap-2">
              <svg
                className="animate-spin h-5 w-5"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                />
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                />
              </svg>
              ダウンロード中...
            </span>
          ) : (
            'CSV出力'
          )}
        </button>

        <p className="text-xs text-gray-500">
          ※期間を指定しない場合は全期間のデータが出力されます
        </p>
      </div>
    </div>
  );
}
```

---

## 運用に関する注意事項

### ファイルサイズ制限

**Next.js設定**:

```javascript
// next.config.js
module.exports = {
  api: {
    bodyParser: {
      sizeLimit: '10mb',
    },
  },
};
```

**環境変数**:

```bash
# .env
MAX_FILE_SIZE=10485760  # 10MB in bytes
MAX_UPLOAD_ROWS=1000
CSV_BATCH_SIZE=500
```

### エラーハンドリング戦略

#### アップロード時

```typescript
// lib/services/error-handler.ts
export class FileUploadError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any
  ) {
    super(message);
    this.name = 'FileUploadError';
  }
}

export function handleUploadError(error: unknown) {
  if (error instanceof FileUploadError) {
    return {
      success: false,
      error: error.message,
      code: error.code,
      details: error.details,
    };
  }

  if (error instanceof z.ZodError) {
    return {
      success: false,
      error: 'バリデーションエラー',
      code: 'VALIDATION_ERROR',
      details: error.errors,
    };
  }

  console.error('Unexpected error:', error);
  return {
    success: false,
    error: '予期しないエラーが発生しました',
    code: 'INTERNAL_ERROR',
  };
}
```

#### ダウンロード時

```typescript
// lib/services/download-error-handler.ts
export async function handleDownloadError(error: unknown) {
  console.error('Download error:', error);

  if (error instanceof Error) {
    if (error.message.includes('ENOSPC')) {
      throw new Error('ディスク容量が不足しています');
    }

    if (error.message.includes('EACCES')) {
      throw new Error('ファイルへのアクセス権限がありません');
    }
  }

  throw new Error('ファイルのダウンロード中にエラーが発生しました');
}
```

### パフォーマンス最適化

#### Streaming処理

大容量データの場合はStreaming Responseを使用:

```typescript
// app/api/projects/download/large/route.ts
export async function GET(request: NextRequest) {
  const encoder = new TextEncoder();

  const stream = new ReadableStream({
    async start(controller) {
      try {
        // BOM
        controller.enqueue(encoder.encode('\uFEFF'));

        // Header
        controller.enqueue(encoder.encode('project_id,project_name,...\r\n'));

        // Data in batches
        let offset = 0;
        const batchSize = 500;

        while (true) {
          const batch = await fetchProjectBatch(offset, batchSize);

          if (batch.length === 0) break;

          for (const row of batch) {
            const csvRow = formatCsvRow(row);
            controller.enqueue(encoder.encode(csvRow + '\r\n'));
          }

          offset += batchSize;

          if (batch.length < batchSize) break;
        }

        controller.close();
      } catch (error) {
        controller.error(error);
      }
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/csv; charset=utf-8',
      'Content-Disposition': 'attachment; filename="projects.csv"',
    },
  });
}
```

#### メモリ使用量監視

```typescript
// lib/utils/memory-monitor.ts
export function checkMemoryUsage() {
  if (typeof process !== 'undefined' && process.memoryUsage) {
    const usage = process.memoryUsage();
    const heapUsedMB = usage.heapUsed / 1024 / 1024;

    if (heapUsedMB > 500) {
      console.warn(`High memory usage: ${heapUsedMB.toFixed(2)}MB`);
    }
  }
}
```

### セキュリティ対策

#### CSVインジェクション対策

```typescript
// lib/utils/csv-sanitize.ts
export function sanitizeCsvValue(value: string): string {
  // CSVインジェクション対策: =, +, -, @ で始まる値をエスケープ
  if (/^[=+\-@]/.test(value)) {
    return `'${value}`;
  }
  return value;
}
```

#### ファイル名サニタイズ

```typescript
// lib/utils/file-sanitize.ts
export function sanitizeFileName(fileName: string): string {
  // 危険な文字を除去
  return fileName
    .replace(/[^a-zA-Z0-9._-]/g, '_')
    .replace(/\.{2,}/g, '.')
    .substring(0, 255);
}
```

### ロギング

```typescript
// lib/utils/file-logger.ts
export async function logFileOperation(
  operation: 'upload' | 'download',
  userId: string,
  fileName: string,
  status: 'success' | 'error',
  details?: any
) {
  const logEntry = {
    timestamp: new Date().toISOString(),
    operation,
    userId,
    fileName,
    status,
    details,
  };

  // データベースまたはログファイルに記録
  console.log('File operation:', logEntry);

  // 本番環境では適切なロギングサービスを使用
  // await db.insert(fileLogs).values(logEntry);
}
```

---

## 改訂履歴

| バージョン | 改訂日 | 改訂内容 | 改訂者 |
|-----------|--------|---------|--------|
| 1.0 | 2025-11-27 | 初版作成 (Spring Boot版) | システム設計チーム |
| 2.0 | 2025-11-27 | Next.js版に全面改訂 | システム設計チーム |

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| 作成者 | | | |
| レビュー担当者 | | | |
| 承認者 | | | |

---

**文書の終わり**
