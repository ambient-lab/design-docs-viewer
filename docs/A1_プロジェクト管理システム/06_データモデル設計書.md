# ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆæ›¸

## æ–‡æ›¸æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ã‚·ã‚¹ãƒ†ãƒ å | A1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  |
| æ–‡æ›¸å | ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆæ›¸ (Prisma ORM) |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 2.0 |
| æœ€çµ‚æ›´æ–°æ—¥ | 2025-11-27 |
| å¯¾è±¡æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ | Next.js + Prisma + PostgreSQL |

## ç›®æ¬¡

1. [Prisma Schemaæ¦‚è¦](#1-prisma-schemaæ¦‚è¦)
2. [ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ãƒ¢ãƒ‡ãƒ«](#2-ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ãƒ¢ãƒ‡ãƒ«)
3. [ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—](#3-ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—)
4. [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥](#4-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥)
5. [ERå›³](#5-erå›³)
6. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](#6-ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
7. [ã‚·ãƒ¼ãƒ‰](#7-ã‚·ãƒ¼ãƒ‰)
8. [TypeScriptå‹ç”Ÿæˆ](#8-typescriptå‹ç”Ÿæˆ)
9. [ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³](#9-ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)

---

## 1. Prisma Schemaæ¦‚è¦

### 1.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ORM**: Prisma (v5.x+)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL 15+
- **è¨€èª**: TypeScript 5.x+
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Next.js 14+ (App Router)

### 1.2 Prismaè¨­å®š

**prisma/schema.prisma**:
```prisma
// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Prisma Clientã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼è¨­å®š
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}
```

### 1.3 å‘½åè¦å‰‡

| è¦ç´  | Prisma Model | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | èª¬æ˜ |
|------|-------------|-------------|------|
| ãƒ¢ãƒ‡ãƒ«å | PascalCase | snake_case | `Project` â†’ `projects` |
| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | camelCase | snake_case | `projectName` â†’ `project_name` |
| ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | camelCase | - | `organization`, `projectType` |
| åˆ—åãƒãƒƒãƒ”ãƒ³ã‚° | @map("db_name") | snake_case | DBåˆ—åã‚’æ˜ç¤ºçš„ã«ãƒãƒƒãƒ”ãƒ³ã‚° |
| ãƒ†ãƒ¼ãƒ–ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚° | @@map("table_name") | snake_case | DBãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ˜ç¤ºçš„ã«ãƒãƒƒãƒ”ãƒ³ã‚° |

---

## 2. ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ãƒ¢ãƒ‡ãƒ«

### 2.1 Project (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æƒ…å ±ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model Project {
  // ä¸»ã‚­ãƒ¼
  id                Int       @id @default(autoincrement()) @map("project_id")

  // åŸºæœ¬æƒ…å ±
  projectName       String    @db.VarChar(128) @map("project_name")
  projectTypeCode   String    @db.VarChar(2) @map("project_type")
  projectClassCode  String?   @db.VarChar(2) @map("project_class")

  // æœŸé–“
  projectStartDate  DateTime? @db.Date @map("project_start_date")
  projectEndDate    DateTime? @db.Date @map("project_end_date")

  // é–¢é€£ID
  organizationId    Int?      @map("organization_id")
  clientId          Int       @map("client_id")

  // æ‹…å½“è€…
  projectManager    String?   @db.VarChar(64) @map("project_manager")
  projectLeader     String?   @db.VarChar(64) @map("project_leader")

  // ãã®ä»–
  note              String?   @db.VarChar(512)
  sales             BigInt?   @db.BigInt

  // æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡
  versionNo         BigInt    @default(0) @map("version_no")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  organization      Organization?  @relation(fields: [organizationId], references: [id])
  projectType       Code           @relation("ProjectType", fields: [projectTypeCode], references: [codeValue])
  projectClass      Code?          @relation("ProjectClass", fields: [projectClassCode], references: [codeValue])
  userProjects      UserProject[]

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  @@index([projectName], name: "idx_project_name")
  @@index([projectTypeCode], name: "idx_project_type")
  @@index([organizationId], name: "idx_organization_id")
  @@index([projectStartDate, projectEndDate], name: "idx_project_dates")

  // ãƒ†ãƒ¼ãƒ–ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°
  @@map("projects")
}
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|-----|------|-----------|------|
| id | Int | Ã— | autoincrement | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID (è‡ªå‹•æ¡ç•ª) |
| projectName | String | Ã— | - | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (æœ€å¤§128æ–‡å­—) |
| projectTypeCode | String | Ã— | - | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥ã‚³ãƒ¼ãƒ‰ |
| projectClassCode | String | â—‹ | - | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†é¡ã‚³ãƒ¼ãƒ‰ |
| projectStartDate | DateTime | â—‹ | - | é–‹å§‹æ—¥ä»˜ |
| projectEndDate | DateTime | â—‹ | - | çµ‚äº†æ—¥ä»˜ |
| organizationId | Int | â—‹ | - | çµ„ç¹”ID (å¤–éƒ¨ã‚­ãƒ¼) |
| clientId | Int | Ã— | - | é¡§å®¢ID |
| projectManager | String | â—‹ | - | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å |
| projectLeader | String | â—‹ | - | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼å |
| note | String | â—‹ | - | å‚™è€ƒ (æœ€å¤§512æ–‡å­—) |
| sales | BigInt | â—‹ | - | å£²ä¸Šé«˜ (å††å˜ä½) |
| versionNo | BigInt | Ã— | 0 | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå· (æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡) |

---

### 2.2 ProjectWork (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæ¥­ãƒ†ãƒ¼ãƒ–ãƒ«)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: CSVä¸€æ‹¬ç™»éŒ²æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«

**Prisma Schema**:
```prisma
model ProjectWork {
  // ä¸€æ™‚ID (ä¸»ã‚­ãƒ¼ä¸è¦ã ãŒã€Prismaã®åˆ¶ç´„ä¸Šè¿½åŠ )
  id                Int       @id @default(autoincrement()) @map("work_id")

  // PROJECTç›¸å½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (å…¨ã¦NULLè¨±å¯)
  projectId         Int?      @map("project_id")
  projectName       String?   @db.VarChar(128) @map("project_name")
  projectTypeCode   String?   @db.VarChar(2) @map("project_type")
  projectClassCode  String?   @db.VarChar(2) @map("project_class")
  projectStartDate  DateTime? @db.Date @map("project_start_date")
  projectEndDate    DateTime? @db.Date @map("project_end_date")
  organizationId    Int?      @map("organization_id")
  clientId          Int?      @map("client_id")
  projectManager    String?   @db.VarChar(64) @map("project_manager")
  projectLeader     String?   @db.VarChar(64) @map("project_leader")
  note              String?   @db.VarChar(512)
  sales             BigInt?   @db.BigInt

  // ä½œæ¥­ãƒ†ãƒ¼ãƒ–ãƒ«å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  importedAt        DateTime  @default(now()) @map("imported_at")
  validationError   String?   @db.Text @map("validation_error")

  @@map("project_work")
}
```

**å‚™è€ƒ**:
- ä¸€æ‹¬ç™»éŒ²å‡¦ç†ã®å‰ã«`DELETE FROM project_work`ã§å…¨å‰Šé™¤
- CSVãƒ‡ãƒ¼ã‚¿ã‚’`createMany()`ã§ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆ
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã€æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã‚’`projects`ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç§»è¡Œ

---

### 2.3 Organization (çµ„ç¹”)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: çµ„ç¹”ã®éšå±¤æ§‹é€ ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model Organization {
  id                    Int              @id @default(autoincrement()) @map("organization_id")
  organizationName      String           @db.VarChar(128) @map("organization_name")
  upperOrganizationId   Int?             @map("upper_organization_id")

  // è‡ªå·±å‚ç…§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  parentOrganization    Organization?    @relation("OrganizationHierarchy", fields: [upperOrganizationId], references: [id])
  childOrganizations    Organization[]   @relation("OrganizationHierarchy")

  // æ‰€å±ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
  projects              Project[]

  @@index([upperOrganizationId], name: "idx_upper_organization_id")
  @@map("organizations")
}
```

**éšå±¤æ§‹é€ ã®ä¾‹**:
```
æœ¬ç¤¾ (upperOrganizationId: null)
 â”œâ”€ é–‹ç™ºéƒ¨ (upperOrganizationId: 1)
 â”‚   â”œâ”€ ç¬¬ä¸€é–‹ç™ºèª² (upperOrganizationId: 2)
 â”‚   â””â”€ ç¬¬äºŒé–‹ç™ºèª² (upperOrganizationId: 2)
 â””â”€ å–¶æ¥­éƒ¨ (upperOrganizationId: 1)
```

---

### 2.4 Code (ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã™ã‚‹å„ç¨®ã‚³ãƒ¼ãƒ‰å€¤ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model Code {
  codeId            String    @db.VarChar(10) @map("code_id")
  codeValue         String    @db.VarChar(2) @map("code_value")
  codeName          String    @db.VarChar(128) @map("code_name")
  sortOrder         Int       @default(0) @map("sort_order")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Projectãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‚ç…§)
  projectsAsType    Project[] @relation("ProjectType")
  projectsAsClass   Project[] @relation("ProjectClass")

  @@id([codeId, codeValue])
  @@index([codeId, sortOrder], name: "idx_code_sort")
  @@map("codes")
}
```

**ã‚³ãƒ¼ãƒ‰å®šç¾©**:

| codeId | ç”¨é€” | ã‚³ãƒ¼ãƒ‰å€¤ä¾‹ |
|--------|------|-----------|
| C0300001 | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥ | 01=é–‹ç™º, 02=ä¿å®ˆ, 03=é‹ç”¨ |
| C0200001 | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†é¡ | 01=å—è¨—, 02=è‡ªç¤¾è£½å“, 03=ç ”ç©¶é–‹ç™º |

**æ³¨æ„**: Prismaã§ã¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§Codeã‚’2å›å‚ç…§ã™ã‚‹ãŸã‚ã€`@relation`ã«åå‰ã‚’ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

### 2.5 SystemAccount (ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model SystemAccount {
  userId            String          @id @db.VarChar(20) @map("user_id")
  password          String          @db.VarChar(128)
  userName          String          @db.VarChar(64) @map("user_name")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  batchRequests     BatchRequest[]
  userProjects      UserProject[]

  @@map("system_accounts")
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …**:
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…ãšãƒãƒƒã‚·ãƒ¥åŒ– (bcrypt, argon2ç­‰)
- Next.jsç’°å¢ƒã§ã¯`next-auth`ã¨ã®çµ±åˆã‚’æ¨å¥¨
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`@exclude`ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«é€ä¿¡ã—ãªã„è¨­å®šã‚’æ¤œè¨

---

### 2.6 BusinessDate (æ¥­å‹™æ—¥ä»˜)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: ã‚·ã‚¹ãƒ†ãƒ ã®æ¥­å‹™æ—¥ä»˜ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model BusinessDate {
  segmentId         String    @id @db.VarChar(20) @map("segment_id")
  businessDate      DateTime  @db.Date @map("business_date")

  @@map("business_dates")
}
```

**ç”¨é€”**:
- ãƒãƒƒãƒå‡¦ç†ã§ã®æ—¥ä»˜åˆ¶å¾¡
- é€šå¸¸ã¯`segmentId = "default"`ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ä½¿ç”¨

---

### 2.7 BatchRequest (ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆ)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: éåŒæœŸãƒãƒƒãƒå‡¦ç†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†

**Prisma Schema**:
```prisma
enum BatchStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

model BatchRequest {
  id                Int           @id @default(autoincrement()) @map("request_id")
  userId            String        @db.VarChar(20) @map("user_id")
  status            BatchStatus   @default(PENDING)
  requestDatetime   DateTime      @default(now()) @map("request_datetime")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user              SystemAccount @relation(fields: [userId], references: [userId])

  @@index([status], name: "idx_batch_status")
  @@index([userId], name: "idx_batch_user")
  @@map("batch_requests")
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»**:
```
PENDING â†’ RUNNING â†’ SUCCESS
                  â†’ FAILED
```

---

### 2.8 UserProject (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)

**ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¤šå¯¾å¤šé–¢é€£ã‚’ç®¡ç†

**Prisma Schema**:
```prisma
model UserProject {
  userId            String        @db.VarChar(20) @map("user_id")
  projectId         Int           @map("project_id")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user              SystemAccount @relation(fields: [userId], references: [userId], onDelete: Cascade)
  project           Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([userId, projectId])
  @@index([userId], name: "idx_user_project_user")
  @@index([projectId], name: "idx_user_project_project")
  @@map("user_projects")
}
```

**å‰Šé™¤æ™‚å‹•ä½œ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚: é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤ (CASCADE)
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤æ™‚: é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚å‰Šé™¤ (CASCADE)

---

## 3. ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—

### 3.1 ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§

```mermaid
erDiagram
    SystemAccount ||--o{ BatchRequest : "ä½œæˆ"
    SystemAccount ||--o{ UserProject : "æ‰€å±"
    Project ||--o{ UserProject : "å‚åŠ "
    Organization ||--o{ Project : "ç®¡ç†"
    Organization ||--o{ Organization : "éšå±¤"
    Code ||--o{ Project : "ç¨®åˆ¥"
    Code ||--o{ Project : "åˆ†é¡"

    SystemAccount {
        string userId PK
        string password
        string userName
    }

    Project {
        int id PK
        string projectName
        string projectTypeCode FK
        string projectClassCode FK
        int organizationId FK
        int clientId
        datetime projectStartDate
        datetime projectEndDate
        string projectManager
        string projectLeader
        string note
        bigint sales
        bigint versionNo
    }

    Organization {
        int id PK
        string organizationName
        int upperOrganizationId FK
    }

    Code {
        string codeId PK
        string codeValue PK
        string codeName
        int sortOrder
    }

    BatchRequest {
        int id PK
        string userId FK
        enum status
        datetime requestDatetime
    }

    UserProject {
        string userId PK,FK
        int projectId PK,FK
    }
```

### 3.2 ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°

| è¦ªãƒ†ãƒ¼ãƒ–ãƒ« | å­ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¨®åˆ¥ | å‚™è€ƒ |
|----------|-----------|----------------|----------------|------|
| SystemAccount | BatchRequest | 1 : N | ä¸€å¯¾å¤š | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãƒãƒƒãƒã‚’å®Ÿè¡Œå¯èƒ½ |
| SystemAccount | UserProject | 1 : N | å¤šå¯¾å¤š (ä¸­é–“) | ãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–¢é€£ |
| Project | UserProject | 1 : N | å¤šå¯¾å¤š (ä¸­é–“) | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ-ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ |
| Organization | Project | 1 : N | ä¸€å¯¾å¤š | çµ„ç¹”ã¯è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç† |
| Organization | Organization | 1 : N | è‡ªå·±å‚ç…§ | çµ„ç¹”éšå±¤æ§‹é€  |
| Code | Project (type) | 1 : N | ä¸€å¯¾å¤š | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥ã‚³ãƒ¼ãƒ‰ |
| Code | Project (class) | 1 : N | ä¸€å¯¾å¤š | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†é¡ã‚³ãƒ¼ãƒ‰ |

### 3.3 å‚ç…§æ•´åˆæ€§ (Referential Actions)

**Prisma ã§ã®è¨­å®š**:

```prisma
// CASCADE: è¦ªå‰Šé™¤æ™‚ã«å­ã‚‚å‰Šé™¤
project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

// Restrict: è¦ªå‰Šé™¤ã‚’ç¦æ­¢ (å­ãŒå­˜åœ¨ã™ã‚‹å ´åˆ)
organization  Organization  @relation(fields: [organizationId], references: [id], onDelete: Restrict)

// SetNull: è¦ªå‰Šé™¤æ™‚ã«å¤–éƒ¨ã‚­ãƒ¼ã‚’NULLã«è¨­å®š
parentOrganization  Organization?  @relation(fields: [upperOrganizationId], references: [id], onDelete: SetNull)
```

| ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | onDelete | onUpdate | ç†ç”± |
|------------|----------|----------|------|
| Project â†’ Organization | Restrict | Cascade | çµ„ç¹”å‰Šé™¤å‰ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç§»å‹• |
| Project â†’ Code (type) | Restrict | Cascade | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã¯å‚ç…§ç¢ºèªå¾Œ |
| Project â†’ Code (class) | Restrict | Cascade | ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã¯å‚ç…§ç¢ºèªå¾Œ |
| Organization â†’ Organization | SetNull | Cascade | è¦ªçµ„ç¹”å‰Šé™¤æ™‚ã¯æœ€ä¸Šä½åŒ– |
| UserProject â†’ User | Cascade | Cascade | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã¯é–¢é€£ã‚‚å‰Šé™¤ |
| UserProject â†’ Project | Cascade | Cascade | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤æ™‚ã¯é–¢é€£ã‚‚å‰Šé™¤ |

---

## 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### 4.1 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å | ã‚«ãƒ©ãƒ  | ç›®çš„ | ç¨®é¡ |
|---------|--------------|--------|------|------|
| projects | idx_project_name | project_name | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæ¤œç´¢ | B-TREE |
| projects | idx_project_type | project_type | ç¨®åˆ¥çµã‚Šè¾¼ã¿ | B-TREE |
| projects | idx_organization_id | organization_id | çµ„ç¹”å˜ä½æ¤œç´¢ | B-TREE |
| projects | idx_project_dates | project_start_date, project_end_date | æœŸé–“æ¤œç´¢ | B-TREE |
| organizations | idx_upper_organization_id | upper_organization_id | éšå±¤æ¤œç´¢ | B-TREE |
| codes | idx_code_sort | code_id, sort_order | ã‚½ãƒ¼ãƒˆé †å–å¾— | B-TREE |
| batch_requests | idx_batch_status | status | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¤œç´¢ | B-TREE |
| batch_requests | idx_batch_user | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æ¤œç´¢ | B-TREE |
| user_projects | idx_user_project_user | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ | B-TREE |
| user_projects | idx_user_project_project | project_id | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ | B-TREE |

### 4.2 è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­å®š

**Prisma Schemaä¾‹**:
```prisma
model Project {
  // ... fields

  @@index([organizationId, projectTypeCode], name: "idx_org_type")
  @@index([projectStartDate, projectEndDate], name: "idx_project_dates")
}
```

### 4.3 å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (PostgreSQL)

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®å…¨æ–‡æ¤œç´¢**:
```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

model Project {
  // ... fields

  @@index([projectName], type: Hash, name: "idx_project_name_fts")
}
```

**ä½¿ç”¨ä¾‹** (TypeScript):
```typescript
const results = await prisma.project.findMany({
  where: {
    projectName: {
      search: 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
    },
  },
});
```

---

## 5. ERå›³

### 5.1 ERå›³ (Mermaid)

```mermaid
erDiagram
    SystemAccount ||--o{ BatchRequest : creates
    SystemAccount ||--o{ UserProject : belongs_to
    Project ||--o{ UserProject : has
    Organization ||--o{ Project : manages
    Organization ||--o{ Organization : parent_of
    Code ||--o{ Project : type_of
    Code ||--o{ Project : class_of

    SystemAccount {
        varchar(20) user_id PK "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
        varchar(128) password "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ãƒãƒƒã‚·ãƒ¥)"
        varchar(64) user_name "ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
    }

    Project {
        int project_id PK "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID"
        varchar(128) project_name "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå"
        varchar(2) project_type FK "ç¨®åˆ¥ã‚³ãƒ¼ãƒ‰"
        varchar(2) project_class FK "åˆ†é¡ã‚³ãƒ¼ãƒ‰"
        date project_start_date "é–‹å§‹æ—¥"
        date project_end_date "çµ‚äº†æ—¥"
        int organization_id FK "çµ„ç¹”ID"
        int client_id "é¡§å®¢ID"
        varchar(64) project_manager "PM"
        varchar(64) project_leader "PL"
        varchar(512) note "å‚™è€ƒ"
        bigint sales "å£²ä¸Šé«˜"
        bigint version_no "ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
    }

    Organization {
        int organization_id PK "çµ„ç¹”ID"
        varchar(128) organization_name "çµ„ç¹”å"
        int upper_organization_id FK "ä¸Šä½çµ„ç¹”ID"
    }

    Code {
        varchar(10) code_id PK "ã‚³ãƒ¼ãƒ‰ID"
        varchar(2) code_value PK "ã‚³ãƒ¼ãƒ‰å€¤"
        varchar(128) code_name "ã‚³ãƒ¼ãƒ‰å"
        int sort_order "è¡¨ç¤ºé †"
    }

    BatchRequest {
        int request_id PK "ãƒªã‚¯ã‚¨ã‚¹ãƒˆID"
        varchar(20) user_id FK "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
        varchar(20) status "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
        timestamp request_datetime "ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ—¥æ™‚"
    }

    UserProject {
        varchar(20) user_id PK,FK "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
        int project_id PK,FK "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID"
    }

    BusinessDate {
        varchar(20) segment_id PK "ã‚»ã‚°ãƒ¡ãƒ³ãƒˆID"
        date business_date "æ¥­å‹™æ—¥ä»˜"
    }

    ProjectWork {
        int work_id PK "ä½œæ¥­ID"
        int project_id "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID (ä»®)"
        varchar(128) project_name "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (ä»®)"
        timestamp imported_at "ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ—¥æ™‚"
        text validation_error "æ¤œè¨¼ã‚¨ãƒ©ãƒ¼"
    }
```

### 5.2 è©³ç´°ERå›³ (ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SystemAccount            â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK: user_id                  â”‚
â”‚     password                 â”‚
â”‚     user_name                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â”‚ 1              â”‚ 1
         â”‚                â”‚
         â”‚ N              â”‚ N
         â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BatchRequest    â”‚  â”‚  UserProject     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK: request_id   â”‚  â”‚ PK,FK: user_id   â”‚
â”‚ FK: user_id      â”‚  â”‚ PK,FK: project_idâ”‚
â”‚     status       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ request_datetime â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ N
                               â”‚
                               â”‚ 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Project                 â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK: project_id                       â”‚
â”‚     project_name                     â”‚
â”‚ FK: project_type â”€â”€â”€â”                â”‚
â”‚ FK: project_class â”€â”€â”¼â”€â”€â”€â”            â”‚
â”‚ FK: organization_id â”‚   â”‚            â”‚
â”‚     client_id       â”‚   â”‚            â”‚
â”‚     project_manager â”‚   â”‚            â”‚
â”‚     project_leader  â”‚   â”‚            â”‚
â”‚     project_start_date              â”‚
â”‚     project_end_date                â”‚
â”‚     note                             â”‚
â”‚     sales                            â”‚
â”‚     version_no                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚    â”‚
         â”‚ N                 â”‚    â”‚
         â”‚ 1                 â”‚    â”‚
         â–¼                   â”‚    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚   Organization       â”‚     â”‚    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚    â”‚
â”‚ PK: organization_id  â”‚     â”‚    â”‚
â”‚     organization_nameâ”‚     â”‚    â”‚
â”‚ FK: upper_org_id â”€â”€â”€â”€â”¼â”€â”€â”  â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚    â”‚
         â”‚                â”‚  â”‚    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
              è‡ªå·±å‚ç…§       â”‚    â”‚
                            â”‚    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”
â”‚          Code             â”‚    â”‚  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚  â”‚
â”‚ PK: code_id, code_value   â”‚    â”‚  â”‚
â”‚     code_name             â”‚    â”‚  â”‚
â”‚     sort_order            â”‚    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”˜
                            â”‚    â”‚
                            â–²    â–²
                            â”‚ 1  â”‚ 1
                            â”‚    â”‚
                            â””â”€â”€â”€â”€â”´â”€â”€â”€
                       C0300001  C0200001
                       (ç¨®åˆ¥)     (åˆ†é¡)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ProjectWork        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK: work_id          â”‚
â”‚     project_id       â”‚
â”‚     project_name     â”‚
â”‚     ...              â”‚
â”‚     imported_at      â”‚
â”‚     validation_error â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BusinessDate       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK: segment_id       â”‚
â”‚     business_date    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 6.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦

Prismaã§ã¯ã€ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã™ã‚‹ãŸã‚ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### 6.2 é–‹ç™ºç’°å¢ƒã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ**:
```bash
# ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
npx prisma migrate dev --name init

# å®Ÿè¡Œå†…å®¹:
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLã‚’ç”Ÿæˆ (prisma/migrations/é…ä¸‹)
# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é©ç”¨
# 3. Prisma Clientã‚’å†ç”Ÿæˆ
```

**ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¾Œã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸå ´åˆ
npx prisma migrate dev --name add_project_budget

# å‘½åè¦å‰‡: add_*, remove_*, update_*, create_table_*
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ **:
```
prisma/
â”œâ”€â”€ schema.prisma
â””â”€â”€ migrations/
    â”œâ”€â”€ 20250127000001_init/
    â”‚   â””â”€â”€ migration.sql
    â”œâ”€â”€ 20250127000002_add_project_budget/
    â”‚   â””â”€â”€ migration.sql
    â””â”€â”€ migration_lock.toml
```

### 6.3 æœ¬ç•ªç’°å¢ƒã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ (æœ¬ç•ª)**:
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿å®Ÿè¡Œ (é–‹ç™ºç’°å¢ƒã®ä½œæ¥­ä¸è¦)
npx prisma migrate deploy

# å®Ÿè¡Œå†…å®¹:
# - æœªé©ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é †æ¬¡å®Ÿè¡Œ
# - _prisma_migrationsãƒ†ãƒ¼ãƒ–ãƒ«ã§é©ç”¨å±¥æ­´ã‚’ç®¡ç†
```

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:
```bash
# Prismaã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€æ‰‹å‹•ã§å¯¾å¿œ
# 1. ä»¥å‰ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§æˆ»ã™
npx prisma migrate resolve --rolled-back 20250127000002_add_project_budget

# 2. ä¿®æ­£å¾Œã€å†åº¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma migrate dev --name fix_project_budget
```

### 6.4 ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—é–‹ç™ºæ™‚ (db push)

**ã‚¹ã‚­ãƒ¼ãƒã‚’ç›´æ¥é©ç”¨ (ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãªã—)**:
```bash
# é–‹ç™ºåˆæœŸã‚„ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ä½¿ç”¨
npx prisma db push

# ç‰¹å¾´:
# - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ãªã„
# - ã‚¹ã‚­ãƒ¼ãƒã‚’ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ 
# - ãƒ‡ãƒ¼ã‚¿æå¤±ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æœ¬ç•ªç’°å¢ƒã§ã¯éæ¨å¥¨
```

**ä½¿ã„åˆ†ã‘**:
- `migrate dev`: æœ¬ç•ªç’°å¢ƒã‚’è¦‹æ®ãˆãŸé–‹ç™º
- `db push`: ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã€PoCã€ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿé¨“

### 6.5 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹

**åˆæœŸã‚¹ã‚­ãƒ¼ãƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQL** (`prisma/migrations/20250127000001_init/migration.sql`):
```sql
-- CreateEnum
CREATE TYPE "BatchStatus" AS ENUM ('PENDING', 'RUNNING', 'SUCCESS', 'FAILED');

-- CreateTable
CREATE TABLE "system_accounts" (
    "user_id" VARCHAR(20) NOT NULL,
    "password" VARCHAR(128) NOT NULL,
    "user_name" VARCHAR(64) NOT NULL,

    CONSTRAINT "system_accounts_pkey" PRIMARY KEY ("user_id")
);

-- CreateTable
CREATE TABLE "organizations" (
    "organization_id" SERIAL NOT NULL,
    "organization_name" VARCHAR(128) NOT NULL,
    "upper_organization_id" INTEGER,

    CONSTRAINT "organizations_pkey" PRIMARY KEY ("organization_id")
);

-- CreateTable
CREATE TABLE "codes" (
    "code_id" VARCHAR(10) NOT NULL,
    "code_value" VARCHAR(2) NOT NULL,
    "code_name" VARCHAR(128) NOT NULL,
    "sort_order" INTEGER NOT NULL DEFAULT 0,

    CONSTRAINT "codes_pkey" PRIMARY KEY ("code_id","code_value")
);

-- CreateTable
CREATE TABLE "projects" (
    "project_id" SERIAL NOT NULL,
    "project_name" VARCHAR(128) NOT NULL,
    "project_type" VARCHAR(2) NOT NULL,
    "project_class" VARCHAR(2),
    "project_start_date" DATE,
    "project_end_date" DATE,
    "organization_id" INTEGER,
    "client_id" INTEGER NOT NULL,
    "project_manager" VARCHAR(64),
    "project_leader" VARCHAR(64),
    "note" VARCHAR(512),
    "sales" BIGINT,
    "version_no" BIGINT NOT NULL DEFAULT 0,

    CONSTRAINT "projects_pkey" PRIMARY KEY ("project_id")
);

-- CreateTable
CREATE TABLE "project_work" (
    "work_id" SERIAL NOT NULL,
    "project_id" INTEGER,
    "project_name" VARCHAR(128),
    "project_type" VARCHAR(2),
    "project_class" VARCHAR(2),
    "project_start_date" DATE,
    "project_end_date" DATE,
    "organization_id" INTEGER,
    "client_id" INTEGER,
    "project_manager" VARCHAR(64),
    "project_leader" VARCHAR(64),
    "note" VARCHAR(512),
    "sales" BIGINT,
    "imported_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "validation_error" TEXT,

    CONSTRAINT "project_work_pkey" PRIMARY KEY ("work_id")
);

-- CreateTable
CREATE TABLE "batch_requests" (
    "request_id" SERIAL NOT NULL,
    "user_id" VARCHAR(20) NOT NULL,
    "status" "BatchStatus" NOT NULL DEFAULT 'PENDING',
    "request_datetime" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "batch_requests_pkey" PRIMARY KEY ("request_id")
);

-- CreateTable
CREATE TABLE "user_projects" (
    "user_id" VARCHAR(20) NOT NULL,
    "project_id" INTEGER NOT NULL,

    CONSTRAINT "user_projects_pkey" PRIMARY KEY ("user_id","project_id")
);

-- CreateTable
CREATE TABLE "business_dates" (
    "segment_id" VARCHAR(20) NOT NULL,
    "business_date" DATE NOT NULL,

    CONSTRAINT "business_dates_pkey" PRIMARY KEY ("segment_id")
);

-- CreateIndex
CREATE INDEX "idx_upper_organization_id" ON "organizations"("upper_organization_id");

-- CreateIndex
CREATE INDEX "idx_code_sort" ON "codes"("code_id", "sort_order");

-- CreateIndex
CREATE INDEX "idx_project_name" ON "projects"("project_name");

-- CreateIndex
CREATE INDEX "idx_project_type" ON "projects"("project_type");

-- CreateIndex
CREATE INDEX "idx_organization_id" ON "projects"("organization_id");

-- CreateIndex
CREATE INDEX "idx_project_dates" ON "projects"("project_start_date", "project_end_date");

-- CreateIndex
CREATE INDEX "idx_batch_status" ON "batch_requests"("status");

-- CreateIndex
CREATE INDEX "idx_batch_user" ON "batch_requests"("user_id");

-- CreateIndex
CREATE INDEX "idx_user_project_user" ON "user_projects"("user_id");

-- CreateIndex
CREATE INDEX "idx_user_project_project" ON "user_projects"("project_id");

-- AddForeignKey
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_upper_organization_id_fkey"
    FOREIGN KEY ("upper_organization_id") REFERENCES "organizations"("organization_id")
    ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "projects" ADD CONSTRAINT "projects_organization_id_fkey"
    FOREIGN KEY ("organization_id") REFERENCES "organizations"("organization_id")
    ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "projects" ADD CONSTRAINT "projects_project_type_fkey"
    FOREIGN KEY ("project_type") REFERENCES "codes"("code_value")
    ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "projects" ADD CONSTRAINT "projects_project_class_fkey"
    FOREIGN KEY ("project_class") REFERENCES "codes"("code_value")
    ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "batch_requests" ADD CONSTRAINT "batch_requests_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "system_accounts"("user_id")
    ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "user_projects" ADD CONSTRAINT "user_projects_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "system_accounts"("user_id")
    ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "user_projects" ADD CONSTRAINT "user_projects_project_id_fkey"
    FOREIGN KEY ("project_id") REFERENCES "projects"("project_id")
    ON DELETE CASCADE ON UPDATE CASCADE;
```

---

## 7. ã‚·ãƒ¼ãƒ‰

### 7.1 ã‚·ãƒ¼ãƒ‰æ¦‚è¦

ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¯ã€é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

### 7.2 ã‚·ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**prisma/seed.ts**:
```typescript
import { PrismaClient, BatchStatus } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('ğŸŒ± Seeding database...');

  // 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
  await prisma.systemAccount.upsert({
    where: { userId: 'admin' },
    update: {},
    create: {
      userId: 'admin',
      password: '$2b$10$YourHashedPasswordHere', // bcryptãƒãƒƒã‚·ãƒ¥
      userName: 'ç®¡ç†è€…',
    },
  });

  await prisma.systemAccount.createMany({
    data: [
      {
        userId: 'user01',
        password: '$2b$10$YourHashedPasswordHere',
        userName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼01',
      },
      {
        userId: 'user02',
        password: '$2b$10$YourHashedPasswordHere',
        userName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼02',
      },
    ],
    skipDuplicates: true,
  });

  // 2. çµ„ç¹”ãƒ‡ãƒ¼ã‚¿
  const orgHonsha = await prisma.organization.upsert({
    where: { id: 1 },
    update: {},
    create: {
      id: 1,
      organizationName: 'æœ¬ç¤¾',
      upperOrganizationId: null,
    },
  });

  const orgDev = await prisma.organization.upsert({
    where: { id: 2 },
    update: {},
    create: {
      id: 2,
      organizationName: 'é–‹ç™ºéƒ¨',
      upperOrganizationId: orgHonsha.id,
    },
  });

  await prisma.organization.createMany({
    data: [
      {
        id: 3,
        organizationName: 'ç¬¬ä¸€é–‹ç™ºèª²',
        upperOrganizationId: orgDev.id,
      },
      {
        id: 4,
        organizationName: 'ç¬¬äºŒé–‹ç™ºèª²',
        upperOrganizationId: orgDev.id,
      },
      {
        id: 5,
        organizationName: 'å–¶æ¥­éƒ¨',
        upperOrganizationId: orgHonsha.id,
      },
    ],
    skipDuplicates: true,
  });

  // 3. ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥ (C0300001)
  await prisma.code.createMany({
    data: [
      {
        codeId: 'C0300001',
        codeValue: '01',
        codeName: 'é–‹ç™º',
        sortOrder: 1,
      },
      {
        codeId: 'C0300001',
        codeValue: '02',
        codeName: 'ä¿å®ˆ',
        sortOrder: 2,
      },
      {
        codeId: 'C0300001',
        codeValue: '03',
        codeName: 'é‹ç”¨',
        sortOrder: 3,
      },
    ],
    skipDuplicates: true,
  });

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†é¡ (C0200001)
  await prisma.code.createMany({
    data: [
      {
        codeId: 'C0200001',
        codeValue: '01',
        codeName: 'å—è¨—',
        sortOrder: 1,
      },
      {
        codeId: 'C0200001',
        codeValue: '02',
        codeName: 'è‡ªç¤¾è£½å“',
        sortOrder: 2,
      },
      {
        codeId: 'C0200001',
        codeValue: '03',
        codeName: 'ç ”ç©¶é–‹ç™º',
        sortOrder: 3,
      },
    ],
    skipDuplicates: true,
  });

  // 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
  const project1 = await prisma.project.create({
    data: {
      projectName: 'é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
      projectTypeCode: '01', // é–‹ç™º
      projectClassCode: '01', // å—è¨—
      projectStartDate: new Date('2025-01-01'),
      projectEndDate: new Date('2025-12-31'),
      organizationId: 3, // ç¬¬ä¸€é–‹ç™ºèª²
      clientId: 1001,
      projectManager: 'å±±ç”°å¤ªéƒ',
      projectLeader: 'ä½è—¤èŠ±å­',
      note: 'æ–°è¦é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
      sales: 50000000n, // 5000ä¸‡å††
      versionNo: 0n,
    },
  });

  const project2 = await prisma.project.create({
    data: {
      projectName: 'åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ ä¿å®ˆ',
      projectTypeCode: '02', // ä¿å®ˆ
      projectClassCode: '01', // å—è¨—
      projectStartDate: new Date('2025-04-01'),
      projectEndDate: new Date('2026-03-31'),
      organizationId: 4, // ç¬¬äºŒé–‹ç™ºèª²
      clientId: 1002,
      projectManager: 'éˆ´æœ¨ä¸€éƒ',
      projectLeader: 'ç”°ä¸­æ¬¡éƒ',
      note: 'æ—¢å­˜åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ ã®ä¿å®ˆãƒ»é‹ç”¨',
      sales: 20000000n, // 2000ä¸‡å††
      versionNo: 0n,
    },
  });

  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–¢é€£
  await prisma.userProject.createMany({
    data: [
      { userId: 'user01', projectId: project1.id },
      { userId: 'user01', projectId: project2.id },
      { userId: 'user02', projectId: project1.id },
    ],
    skipDuplicates: true,
  });

  // 6. æ¥­å‹™æ—¥ä»˜
  await prisma.businessDate.upsert({
    where: { segmentId: 'default' },
    update: {},
    create: {
      segmentId: 'default',
      businessDate: new Date(),
    },
  });

  // 7. ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ã‚µãƒ³ãƒ—ãƒ«)
  await prisma.batchRequest.create({
    data: {
      userId: 'admin',
      status: BatchStatus.SUCCESS,
      requestDatetime: new Date('2025-01-15T10:00:00Z'),
    },
  });

  console.log('âœ… Seeding completed successfully!');
}

main()
  .catch((e) => {
    console.error('âŒ Seeding failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### 7.3 ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œ

**package.jsonè¨­å®š**:
```json
{
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  },
  "scripts": {
    "db:seed": "prisma db seed"
  }
}
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
npm run db:seed

# ã¾ãŸã¯
npx prisma db seed
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®è‡ªå‹•ã‚·ãƒ¼ãƒ‰**:
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è‡ªå‹•çš„ã«ã‚·ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹
npx prisma migrate dev --name init
```

---

## 8. TypeScriptå‹ç”Ÿæˆ

### 8.1 Prisma Clientè‡ªå‹•ç”Ÿæˆ

Prismaã¯ã€ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å®Œå…¨ã«å‹å®‰å…¨ãªTypeScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ**:
```bash
# Prisma Clientã‚’ç”Ÿæˆ
npx prisma generate

# ç”Ÿæˆå ´æ‰€: node_modules/.prisma/client/
```

### 8.2 ç”Ÿæˆã•ã‚Œã‚‹å‹

**åŸºæœ¬å‹**:
```typescript
// PrismaãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹å‹
import { Project, Organization, Code, SystemAccount } from '@prisma/client';

// ä½¿ç”¨ä¾‹
const project: Project = {
  id: 1,
  projectName: 'ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
  projectTypeCode: '01',
  projectClassCode: '01',
  projectStartDate: new Date('2025-01-01'),
  projectEndDate: new Date('2025-12-31'),
  organizationId: 1,
  clientId: 1001,
  projectManager: 'å±±ç”°å¤ªéƒ',
  projectLeader: 'ä½è—¤èŠ±å­',
  note: 'ã‚µãƒ³ãƒ—ãƒ«',
  sales: 10000000n,
  versionNo: 0n,
};
```

### 8.3 ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚€å‹

**Includeå‹**:
```typescript
import { Prisma } from '@prisma/client';

// ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚€Projectå‹
type ProjectWithRelations = Prisma.ProjectGetPayload<{
  include: {
    organization: true;
    projectType: true;
    projectClass: true;
    userProjects: {
      include: {
        user: true;
      };
    };
  };
}>;

// ä½¿ç”¨ä¾‹
const projectWithRelations: ProjectWithRelations = await prisma.project.findUnique({
  where: { id: 1 },
  include: {
    organization: true,
    projectType: true,
    projectClass: true,
    userProjects: {
      include: {
        user: true,
      },
    },
  },
});
```

### 8.4 Selectå‹ (éƒ¨åˆ†å‹)

**ç‰¹å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—**:
```typescript
// å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’é¸æŠ
type ProjectBasic = Prisma.ProjectGetPayload<{
  select: {
    id: true;
    projectName: true;
    projectStartDate: true;
    projectEndDate: true;
  };
}>;

// ä½¿ç”¨ä¾‹
const projects: ProjectBasic[] = await prisma.project.findMany({
  select: {
    id: true,
    projectName: true,
    projectStartDate: true,
    projectEndDate: true,
  },
});
```

### 8.5 å…¥åŠ›å‹

**Createå‹**:
```typescript
import { Prisma } from '@prisma/client';

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ™‚ã®å…¥åŠ›å‹
type ProjectCreateInput = Prisma.ProjectCreateInput;

const newProject: ProjectCreateInput = {
  projectName: 'æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
  projectTypeCode: '01',
  clientId: 1001,
  organization: {
    connect: { id: 1 },
  },
};
```

**Updateå‹**:
```typescript
type ProjectUpdateInput = Prisma.ProjectUpdateInput;

const updateData: ProjectUpdateInput = {
  projectName: 'æ›´æ–°å¾Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå',
  sales: { increment: 1000000n }, // 100ä¸‡å††åŠ ç®—
};
```

### 8.6 ã‚«ã‚¹ã‚¿ãƒ å‹å®šç¾©

**å…±é€šå‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«** (`lib/types/prisma.ts`):
```typescript
import { Prisma } from '@prisma/client';

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤ºç”¨ã®å‹
export type ProjectListItem = Prisma.ProjectGetPayload<{
  select: {
    id: true;
    projectName: true;
    projectStartDate: true;
    projectEndDate: true;
    organization: {
      select: {
        organizationName: true;
      };
    };
    projectType: {
      select: {
        codeName: true;
      };
    };
  };
}>;

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°è¡¨ç¤ºç”¨ã®å‹
export type ProjectDetail = Prisma.ProjectGetPayload<{
  include: {
    organization: true;
    projectType: true;
    projectClass: true;
    userProjects: {
      include: {
        user: {
          select: {
            userId: true;
            userName: true;
          };
        };
      };
    };
  };
}>;

// ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ç”¨ã®å‹
export type ProjectFormInput = Pick<
  Prisma.ProjectCreateInput,
  | 'projectName'
  | 'projectTypeCode'
  | 'projectClassCode'
  | 'projectStartDate'
  | 'projectEndDate'
  | 'clientId'
  | 'projectManager'
  | 'projectLeader'
  | 'note'
  | 'sales'
>;
```

### 8.7 ä½¿ç”¨ä¾‹ (Next.js Server Actions)

**Server Action** (`app/actions/project.ts`):
```typescript
'use server';

import { prisma } from '@/lib/prisma';
import { ProjectFormInput, ProjectDetail } from '@/lib/types/prisma';
import { revalidatePath } from 'next/cache';

export async function createProject(data: ProjectFormInput): Promise<ProjectDetail> {
  const project = await prisma.project.create({
    data: {
      ...data,
      versionNo: 0n,
      organization: data.organizationId
        ? { connect: { id: data.organizationId } }
        : undefined,
    },
    include: {
      organization: true,
      projectType: true,
      projectClass: true,
      userProjects: {
        include: {
          user: {
            select: {
              userId: true,
              userName: true,
            },
          },
        },
      },
    },
  });

  revalidatePath('/projects');
  return project;
}

export async function getProjectById(id: number): Promise<ProjectDetail | null> {
  return prisma.project.findUnique({
    where: { id },
    include: {
      organization: true,
      projectType: true,
      projectClass: true,
      userProjects: {
        include: {
          user: {
            select: {
              userId: true,
              userName: true,
            },
          },
        },
      },
    },
  });
}
```

---

## 9. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### 9.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„

**Prisma Schemaã§ã®åˆ¶ç´„å®šç¾©**:
```prisma
model Project {
  // ... fields

  // CHECKåˆ¶ç´„ (PostgreSQL)
  // æ³¨æ„: Prismaã¯ç›´æ¥CHECKåˆ¶ç´„ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€
  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLã§è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLã§ã®åˆ¶ç´„è¿½åŠ **:
```sql
-- prisma/migrations/XXX_add_constraints/migration.sql

-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé–“ã®å¦¥å½“æ€§
ALTER TABLE projects
ADD CONSTRAINT chk_project_dates
CHECK (project_end_date IS NULL OR project_start_date IS NULL OR project_end_date >= project_start_date);

-- å£²ä¸Šé«˜ã¯0ä»¥ä¸Š
ALTER TABLE projects
ADD CONSTRAINT chk_sales_positive
CHECK (sales IS NULL OR sales >= 0);

-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã¯0ä»¥ä¸Š
ALTER TABLE projects
ADD CONSTRAINT chk_version_positive
CHECK (version_no >= 0);

-- ã‚³ãƒ¼ãƒ‰IDã®å½¢å¼
ALTER TABLE codes
ADD CONSTRAINT chk_code_id_format
CHECK (code_id ~ '^C[0-9]{7}$');

-- ãƒãƒƒãƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¶é™ (ENUMã§æ—¢ã«åˆ¶ç´„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ä¸è¦)
```

### 9.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³** (`lib/validations/project.ts`):
```typescript
import { z } from 'zod';

export const projectFormSchema = z.object({
  projectName: z
    .string()
    .min(1, 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯å¿…é ˆã§ã™')
    .max(128, 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯128æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„'),

  projectTypeCode: z
    .string()
    .length(2, 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„'),

  projectClassCode: z
    .string()
    .length(2)
    .optional()
    .nullable(),

  projectStartDate: z
    .date()
    .optional()
    .nullable(),

  projectEndDate: z
    .date()
    .optional()
    .nullable(),

  organizationId: z
    .number()
    .int()
    .positive()
    .optional()
    .nullable(),

  clientId: z
    .number()
    .int()
    .positive('é¡§å®¢IDã¯å¿…é ˆã§ã™'),

  projectManager: z
    .string()
    .max(64)
    .optional()
    .nullable(),

  projectLeader: z
    .string()
    .max(64)
    .optional()
    .nullable(),

  note: z
    .string()
    .max(512)
    .optional()
    .nullable(),

  sales: z
    .bigint()
    .nonnegative('å£²ä¸Šé«˜ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
    .optional()
    .nullable(),
}).refine(
  (data) => {
    // çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã§ã‚ã‚‹ã“ã¨
    if (data.projectStartDate && data.projectEndDate) {
      return data.projectEndDate >= data.projectStartDate;
    }
    return true;
  },
  {
    message: 'çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
    path: ['projectEndDate'],
  }
);

export type ProjectFormSchema = z.infer<typeof projectFormSchema>;
```

### 9.3 æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯** (`lib/services/project.ts`):
```typescript
import { prisma } from '@/lib/prisma';
import { Prisma } from '@prisma/client';

export class OptimisticLockError extends Error {
  constructor() {
    super('ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™');
    this.name = 'OptimisticLockError';
  }
}

export async function updateProjectWithLock(
  id: number,
  currentVersionNo: bigint,
  data: Prisma.ProjectUpdateInput
) {
  const result = await prisma.project.updateMany({
    where: {
      id,
      versionNo: currentVersionNo, // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è‡´ã‚’æ¡ä»¶ã«
    },
    data: {
      ...data,
      versionNo: { increment: 1 }, // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    },
  });

  if (result.count === 0) {
    // æ›´æ–°å¯¾è±¡ãŒ0ä»¶ = æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
    throw new OptimisticLockError();
  }

  return prisma.project.findUnique({ where: { id } });
}
```

**Server Actionã§ã®ä½¿ç”¨ä¾‹**:
```typescript
'use server';

import { updateProjectWithLock, OptimisticLockError } from '@/lib/services/project';

export async function updateProject(
  id: number,
  versionNo: bigint,
  data: ProjectFormInput
) {
  try {
    const updated = await updateProjectWithLock(id, versionNo, data);
    revalidatePath('/projects');
    return { success: true, project: updated };
  } catch (error) {
    if (error instanceof OptimisticLockError) {
      return { success: false, error: error.message };
    }
    throw error;
  }
}
```

### 9.4 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

**è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒ–**:
```typescript
import { prisma } from '@/lib/prisma';

export async function createProjectWithUsers(
  projectData: Prisma.ProjectCreateInput,
  userIds: string[]
) {
  return prisma.$transaction(async (tx) => {
    // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
    const project = await tx.project.create({
      data: projectData,
    });

    // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–¢é€£ã‚’ä¸€æ‹¬ä½œæˆ
    await tx.userProject.createMany({
      data: userIds.map((userId) => ({
        userId,
        projectId: project.id,
      })),
    });

    return project;
  });
}
```

**ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ (é•·æ™‚é–“å‡¦ç†)**:
```typescript
export async function bulkImportProjects(csvData: ProjectFormInput[]) {
  return prisma.$transaction(
    async (tx) => {
      // 1. ä½œæ¥­ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
      await tx.projectWork.deleteMany({});

      // 2. CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½œæ¥­ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŠ•å…¥
      await tx.projectWork.createMany({
        data: csvData.map((row) => ({
          ...row,
          importedAt: new Date(),
        })),
      });

      // 3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚¨ãƒ©ãƒ¼è¨˜éŒ²)
      const works = await tx.projectWork.findMany();
      const validWorks = works.filter((w) => !w.validationError);

      // 4. æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã‚’PROJECTSãƒ†ãƒ¼ãƒ–ãƒ«ã¸
      const projects = await Promise.all(
        validWorks.map((work) =>
          tx.project.create({
            data: {
              projectName: work.projectName!,
              projectTypeCode: work.projectTypeCode!,
              projectClassCode: work.projectClassCode,
              projectStartDate: work.projectStartDate,
              projectEndDate: work.projectEndDate,
              organizationId: work.organizationId,
              clientId: work.clientId!,
              projectManager: work.projectManager,
              projectLeader: work.projectLeader,
              note: work.note,
              sales: work.sales,
              versionNo: 0n,
            },
          })
        )
      );

      return projects;
    },
    {
      maxWait: 10000, // 10ç§’å¾…æ©Ÿ
      timeout: 60000, // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    }
  );
}
```

---

## 10. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 10.1 N+1å•é¡Œã®å›é¿

**æ‚ªã„ä¾‹ (N+1ç™ºç”Ÿ)**:
```typescript
// âŒ N+1å•é¡Œ
const projects = await prisma.project.findMany();

for (const project of projects) {
  const org = await prisma.organization.findUnique({
    where: { id: project.organizationId },
  });
  console.log(org?.organizationName);
}
```

**è‰¯ã„ä¾‹ (includeã§ä¸€æ‹¬å–å¾—)**:
```typescript
// âœ… 1å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
const projects = await prisma.project.findMany({
  include: {
    organization: true,
    projectType: true,
    projectClass: true,
  },
});

projects.forEach((project) => {
  console.log(project.organization?.organizationName);
});
```

### 10.2 ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

**ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ™ãƒ¼ã‚¹**:
```typescript
export async function getProjectsPaginated(page: number, pageSize: number) {
  const [projects, total] = await Promise.all([
    prisma.project.findMany({
      skip: (page - 1) * pageSize,
      take: pageSize,
      include: {
        organization: true,
        projectType: true,
      },
      orderBy: { id: 'desc' },
    }),
    prisma.project.count(),
  ]);

  return {
    projects,
    pagination: {
      total,
      page,
      pageSize,
      totalPages: Math.ceil(total / pageSize),
    },
  };
}
```

**ã‚«ãƒ¼ã‚½ãƒ«ãƒ™ãƒ¼ã‚¹ (ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)**:
```typescript
export async function getProjectsCursor(cursor?: number, limit = 20) {
  const projects = await prisma.project.findMany({
    take: limit + 1, // æ¬¡ãƒšãƒ¼ã‚¸æœ‰ç„¡åˆ¤å®šã®ãŸã‚+1
    cursor: cursor ? { id: cursor } : undefined,
    include: {
      organization: true,
    },
    orderBy: { id: 'desc' },
  });

  const hasNextPage = projects.length > limit;
  const items = hasNextPage ? projects.slice(0, -1) : projects;
  const nextCursor = hasNextPage ? items[items.length - 1].id : undefined;

  return { items, nextCursor, hasNextPage };
}
```

### 10.3 æ¥ç¶šãƒ—ãƒ¼ãƒªãƒ³ã‚°

**Prisma Accelerate (æ¨å¥¨)**:
```prisma
// schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
}
```

**ç’°å¢ƒå¤‰æ•°** (`.env`):
```env
# Prisma AccelerateçµŒç”± (æœ¬ç•ªç’°å¢ƒ)
DATABASE_URL="prisma://accelerate.prisma-data.net/?api_key=..."

# ç›´æ¥æ¥ç¶š (ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
DIRECT_URL="postgresql://user:password@localhost:5432/mydb?pgbouncer=true"
```

---

## 11. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´æ—¥ | å¤‰æ›´è€… | å¤‰æ›´å†…å®¹ |
|----------|--------|-------|---------|
| 2.0 | 2025-11-27 | - | Next.js + Prismaç‰ˆã«å…¨é¢æ”¹è¨‚ |
| 1.0 | 2025-11-27 | - | åˆç‰ˆä½œæˆ (Spring + MyBatisç‰ˆ) |

---

## 12. å‚è€ƒè³‡æ–™

### 12.1 å†…éƒ¨è³‡æ–™
- [01_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦æ›¸.md](./01_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦æ›¸.md)
- [02_è¦ä»¶å®šç¾©æ›¸.md](./02_è¦ä»¶å®šç¾©æ›¸.md)
- [04_å¤–éƒ¨è¨­è¨ˆæ›¸.md](./04_å¤–éƒ¨è¨­è¨ˆæ›¸.md)
- [05_å†…éƒ¨è¨­è¨ˆæ›¸.md](./05_å†…éƒ¨è¨­è¨ˆæ›¸.md)

### 12.2 å¤–éƒ¨è³‡æ–™
- [Prismaå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.prisma.io/docs)
- [Prisma Schema Reference](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)
- [Prisma Client API Reference](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference)
- [Next.js App Router + Prisma](https://www.prisma.io/docs/guides/performance-and-optimization/connection-management#serverless-environments-faas)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

---

**æ–‡æ›¸END**
