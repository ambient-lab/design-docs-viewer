# テスト仕様書

## 文書情報

| 項目 | 内容 |
|------|------|
| システム名 | プロジェクト管理システム |
| サブシステムID | A1 |
| 文書バージョン | 2.0 |
| 最終更新日 | 2025-11-27 |
| ステータス | レビュー中 |
| フレームワーク | Next.js 14+ (App Router) |

## 目次

1. [単体テスト仕様](#単体テスト仕様)
2. [結合テスト仕様](#結合テスト仕様)
3. [E2Eテスト仕様](#e2eテスト仕様)
4. [テスト環境](#テスト環境)
5. [テストデータ](#テストデータ)

---

## 単体テスト仕様

### テストフレームワーク構成

```json
{
  "jest": "^29.7.0",
  "@testing-library/react": "^14.1.0",
  "@testing-library/jest-dom": "^6.1.5",
  "@testing-library/user-event": "^14.5.1",
  "msw": "^2.0.0"
}
```

### テスト設定

#### jest.config.js

```javascript
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/**/__tests__/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}

module.exports = createJestConfig(customJestConfig)
```

#### jest.setup.js

```javascript
import '@testing-library/jest-dom'
import { server } from './src/mocks/server'

beforeAll(() => server.listen())
afterEach(() => server.resetHandlers())
afterAll(() => server.close())
```

---

## コンポーネントテスト仕様

### LoginForm コンポーネント

#### 正常系テスト

**テストファイル**: `src/components/auth/LoginForm.test.tsx`

```typescript
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { LoginForm } from './LoginForm'

describe('LoginForm', () => {
  const mockOnLogin = jest.fn()

  beforeEach(() => {
    mockOnLogin.mockClear()
  })

  describe('正常系', () => {
    test('WA10101-001: 正常ログイン - 正しい認証情報でログインできる', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      // ユーザーIDを入力
      const userIdInput = screen.getByLabelText('ユーザーID')
      await user.type(userIdInput, 'U001')

      // パスワードを入力
      const passwordInput = screen.getByLabelText('パスワード')
      await user.type(passwordInput, 'password123')

      // ログインボタンをクリック
      const loginButton = screen.getByRole('button', { name: 'ログイン' })
      await user.click(loginButton)

      // 認証成功を確認
      await waitFor(() => {
        expect(mockOnLogin).toHaveBeenCalledWith({
          userId: 'U001',
          password: 'password123',
        })
      })
    })

    test('WA10101-002: 初回ログイン - 初回ログインフラグが設定される', async () => {
      const user = userEvent.setup()
      const mockOnFirstLogin = jest.fn()
      render(<LoginForm onLogin={mockOnLogin} onFirstLogin={mockOnFirstLogin} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'U001')
      await user.type(screen.getByLabelText('パスワード'), 'password123')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      await waitFor(() => {
        expect(screen.getByText(/パスワード変更を推奨します/i)).toBeInTheDocument()
      })
    })

    test('WA10101-003: ログイン状態保持 - セッションが保持される', async () => {
      const { rerender } = render(<LoginForm onLogin={mockOnLogin} isAuthenticated={true} />)

      // セッション有効時は自動的にリダイレクト
      expect(screen.queryByLabelText('ユーザーID')).not.toBeInTheDocument()
    })
  })

  describe('異常系', () => {
    test('WA10101-101: ユーザーID未入力 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      await user.type(screen.getByLabelText('パスワード'), 'password123')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      expect(await screen.findByText('ユーザーIDを入力してください')).toBeInTheDocument()
      expect(mockOnLogin).not.toHaveBeenCalled()

      // フォーカスがユーザーID項目に移動
      expect(screen.getByLabelText('ユーザーID')).toHaveFocus()
    })

    test('WA10101-102: パスワード未入力 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'U001')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      expect(await screen.findByText('パスワードを入力してください')).toBeInTheDocument()
      expect(mockOnLogin).not.toHaveBeenCalled()

      // フォーカスがパスワード項目に移動
      expect(screen.getByLabelText('パスワード')).toHaveFocus()
    })

    test('WA10101-103: 両方未入力 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      expect(await screen.findByText('ユーザーIDとパスワードを入力してください')).toBeInTheDocument()
      expect(screen.getByLabelText('ユーザーID')).toHaveFocus()
    })

    test('WA10101-104: 存在しないユーザー - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      const mockOnError = jest.fn()
      render(<LoginForm onLogin={mockOnLogin} onError={mockOnError} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'INVALID')
      await user.type(screen.getByLabelText('パスワード'), 'password123')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      await waitFor(() => {
        expect(screen.getByText('ユーザーIDまたはパスワードが正しくありません')).toBeInTheDocument()
      })

      // 入力値がクリアされる
      expect(screen.getByLabelText('ユーザーID')).toHaveValue('')
      expect(screen.getByLabelText('パスワード')).toHaveValue('')
    })

    test('WA10101-105: パスワード不一致 - ログイン失敗回数カウント', async () => {
      const user = userEvent.setup()
      const mockOnError = jest.fn()
      render(<LoginForm onLogin={mockOnLogin} onError={mockOnError} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'U001')
      await user.type(screen.getByLabelText('パスワード'), 'wrongpassword')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      await waitFor(() => {
        expect(mockOnError).toHaveBeenCalledWith({
          message: 'ユーザーIDまたはパスワードが正しくありません',
          failCount: 1,
        })
      })
    })

    test('WA10101-106: アカウントロック - ログイン処理が拒否される', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} isLocked={true} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'U001')
      await user.type(screen.getByLabelText('パスワード'), 'password123')

      const loginButton = screen.getByRole('button', { name: 'ログイン' })
      expect(loginButton).toBeDisabled()

      expect(screen.getByText('アカウントがロックされています。管理者に連絡してください')).toBeInTheDocument()
    })

    test('WA10101-107: 削除済みユーザー - ログイン処理が拒否される', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      await user.type(screen.getByLabelText('ユーザーID'), 'U999')
      await user.type(screen.getByLabelText('パスワード'), 'password123')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      await waitFor(() => {
        expect(screen.getByText('このアカウントは無効です')).toBeInTheDocument()
      })
    })

    test('WA10101-108: SQLインジェクション対策 - 不正な入力が無害化される', async () => {
      const user = userEvent.setup()
      const mockOnLogin = jest.fn()
      render(<LoginForm onLogin={mockOnLogin} />)

      const maliciousInput = "admin' OR '1'='1"
      await user.type(screen.getByLabelText('ユーザーID'), maliciousInput)
      await user.type(screen.getByLabelText('パスワード'), 'password')
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      await waitFor(() => {
        // サニタイズされた入力値が送信される
        expect(mockOnLogin).toHaveBeenCalledWith({
          userId: expect.not.stringContaining("OR '1'='1"),
          password: 'password',
        })
      })
    })

    test('WA10101-109: XSS対策 - スクリプトが実行されない', async () => {
      const user = userEvent.setup()
      render(<LoginForm onLogin={mockOnLogin} />)

      const xssInput = '<script>alert("XSS")</script>'
      await user.type(screen.getByLabelText('ユーザーID'), xssInput)
      await user.click(screen.getByRole('button', { name: 'ログイン' }))

      // スクリプトがエスケープされて表示される
      const userIdInput = screen.getByLabelText('ユーザーID')
      expect(userIdInput).toHaveValue('&lt;script&gt;alert("XSS")&lt;/script&gt;')
    })
  })
})
```

---

### ProjectSearchForm コンポーネント

#### 正常系テスト

**テストファイル**: `src/components/project/ProjectSearchForm.test.tsx`

```typescript
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { ProjectSearchForm } from './ProjectSearchForm'

describe('ProjectSearchForm', () => {
  const mockOnSearch = jest.fn()

  beforeEach(() => {
    mockOnSearch.mockClear()
  })

  describe('正常系', () => {
    test('検索ボタンクリックで検索が実行される', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テストプロジェクト')
      await user.click(screen.getByRole('button', { name: '検索' }))

      await waitFor(() => {
        expect(mockOnSearch).toHaveBeenCalledWith({
          projectName: 'テストプロジェクト',
        })
      })
    })

    test('プロジェクト種別でフィルタリングできる', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      await user.selectOptions(screen.getByLabelText('プロジェクト種別'), '開発')
      await user.click(screen.getByRole('button', { name: '検索' }))

      await waitFor(() => {
        expect(mockOnSearch).toHaveBeenCalledWith({
          projectType: '開発',
        })
      })
    })

    test('日付範囲で検索できる', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      await user.type(screen.getByLabelText('開始日(from)'), '2025-01-01')
      await user.type(screen.getByLabelText('開始日(to)'), '2025-12-31')
      await user.click(screen.getByRole('button', { name: '検索' }))

      await waitFor(() => {
        expect(mockOnSearch).toHaveBeenCalledWith({
          startDateFrom: '2025-01-01',
          startDateTo: '2025-12-31',
        })
      })
    })

    test('クリアボタンで検索条件がリセットされる', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テスト')
      await user.click(screen.getByRole('button', { name: 'クリア' }))

      expect(screen.getByLabelText('プロジェクト名')).toHaveValue('')
    })
  })

  describe('異常系', () => {
    test('日付の前後関係エラーを検出する', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      await user.type(screen.getByLabelText('開始日(from)'), '2025-12-31')
      await user.type(screen.getByLabelText('開始日(to)'), '2025-01-01')
      await user.click(screen.getByRole('button', { name: '検索' }))

      expect(await screen.findByText('終了日は開始日以降の日付を入力してください')).toBeInTheDocument()
      expect(mockOnSearch).not.toHaveBeenCalled()
    })

    test('不正な日付形式でエラーが表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectSearchForm onSearch={mockOnSearch} />)

      const dateInput = screen.getByLabelText('開始日(from)')
      await user.type(dateInput, '2025/13/32')

      expect(await screen.findByText('正しい日付を入力してください')).toBeInTheDocument()
    })
  })
})
```

---

### ProjectRegistrationForm コンポーネント

#### 正常系・異常系テスト

**テストファイル**: `src/components/project/ProjectRegistrationForm.test.tsx`

```typescript
import { render, screen, waitFor, within } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { ProjectRegistrationForm } from './ProjectRegistrationForm'

describe('ProjectRegistrationForm', () => {
  const mockOnSubmit = jest.fn()

  beforeEach(() => {
    mockOnSubmit.mockClear()
  })

  describe('正常系', () => {
    test('WA10201-001: 初期表示 - フォームが正しく表示される', () => {
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      expect(screen.getByLabelText('プロジェクト名')).toBeInTheDocument()
      expect(screen.getByLabelText('プロジェクト種別')).toBeInTheDocument()
      expect(screen.getByLabelText('開始日')).toBeInTheDocument()
      expect(screen.getByLabelText('終了日')).toBeInTheDocument()
      expect(screen.getByRole('button', { name: '登録' })).toBeInTheDocument()
      expect(screen.getByRole('button', { name: 'クリア' })).toBeInTheDocument()
    })

    test('WA10201-002: 正常登録(必須項目のみ) - プロジェクトが登録される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テストプロジェクト')
      await user.click(screen.getByLabelText('開発'))
      await user.type(screen.getByLabelText('開始日'), '2025-01-01')
      await user.type(screen.getByLabelText('終了日'), '2025-12-31')
      await user.click(screen.getByRole('button', { name: '登録' }))

      await waitFor(() => {
        expect(mockOnSubmit).toHaveBeenCalledWith({
          projectName: 'テストプロジェクト',
          projectType: '開発',
          startDate: '2025-01-01',
          endDate: '2025-12-31',
        })
      })

      // 成功メッセージの表示
      expect(await screen.findByText('登録しました')).toBeInTheDocument()
    })

    test('WA10201-003: 正常登録(全項目入力) - すべての項目が登録される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テストプロジェクト')
      await user.click(screen.getByLabelText('開発'))
      await user.type(screen.getByLabelText('開始日'), '2025-01-01')
      await user.type(screen.getByLabelText('終了日'), '2025-12-31')

      // 顧客選択
      await user.click(screen.getByRole('button', { name: '顧客選択' }))
      const modal = await screen.findByRole('dialog')
      await user.click(within(modal).getByText('株式会社テスト商事'))
      await user.click(within(modal).getByRole('button', { name: '選択' }))

      // PM選択
      await user.click(screen.getByRole('button', { name: 'PM選択' }))
      const pmModal = await screen.findByRole('dialog')
      await user.click(within(pmModal).getByText('田中太郎'))
      await user.click(within(pmModal).getByRole('button', { name: '選択' }))

      await user.type(screen.getByLabelText('備考'), 'テスト備考')
      await user.click(screen.getByRole('button', { name: '登録' }))

      await waitFor(() => {
        expect(mockOnSubmit).toHaveBeenCalledWith({
          projectName: 'テストプロジェクト',
          projectType: '開発',
          startDate: '2025-01-01',
          endDate: '2025-12-31',
          clientId: 1,
          pmId: 2,
          remarks: 'テスト備考',
        })
      })
    })

    test('WA10201-004: 顧客選択モーダル連携 - 顧客情報が自動設定される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.click(screen.getByRole('button', { name: '顧客選択' }))
      const modal = await screen.findByRole('dialog')

      await user.click(within(modal).getByText('株式会社テスト商事'))
      await user.click(within(modal).getByRole('button', { name: '選択' }))

      // モーダルが閉じる
      await waitFor(() => {
        expect(screen.queryByRole('dialog')).not.toBeInTheDocument()
      })

      // 顧客名が表示され、読み取り専用になる
      expect(screen.getByDisplayValue('株式会社テスト商事')).toBeInTheDocument()
      expect(screen.getByDisplayValue('株式会社テスト商事')).toHaveAttribute('readonly')
    })

    test('WA10201-005: クリア機能 - 全入力項目がクリアされる', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テスト')
      await user.click(screen.getByRole('button', { name: 'クリア' }))

      // 確認ダイアログ
      const confirmDialog = await screen.findByRole('alertdialog')
      await user.click(within(confirmDialog).getByRole('button', { name: 'OK' }))

      // 入力値がクリアされる
      expect(screen.getByLabelText('プロジェクト名')).toHaveValue('')
      expect(screen.getByLabelText('プロジェクト名')).toHaveFocus()
    })
  })

  describe('異常系', () => {
    test('WA10201-101: プロジェクト名未入力 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.click(screen.getByLabelText('開発'))
      await user.type(screen.getByLabelText('開始日'), '2025-01-01')
      await user.type(screen.getByLabelText('終了日'), '2025-12-31')
      await user.click(screen.getByRole('button', { name: '登録' }))

      expect(await screen.findByText('プロジェクト名を入力してください')).toBeInTheDocument()
      expect(mockOnSubmit).not.toHaveBeenCalled()

      // 項目が強調表示される
      expect(screen.getByLabelText('プロジェクト名')).toHaveClass('error')
    })

    test('WA10201-102: プロジェクト名文字数超過 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      const longName = 'あ'.repeat(129)
      await user.type(screen.getByLabelText('プロジェクト名'), longName)
      await user.click(screen.getByRole('button', { name: '登録' }))

      expect(await screen.findByText('プロジェクト名は128文字以内で入力してください')).toBeInTheDocument()
      expect(mockOnSubmit).not.toHaveBeenCalled()
    })

    test('WA10201-103: プロジェクト種別未選択 - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テスト')
      await user.type(screen.getByLabelText('開始日'), '2025-01-01')
      await user.type(screen.getByLabelText('終了日'), '2025-12-31')
      await user.click(screen.getByRole('button', { name: '登録' }))

      expect(await screen.findByText('プロジェクト種別を選択してください')).toBeInTheDocument()
    })

    test('WA10201-106: 日付前後関係エラー - エラーメッセージが表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テスト')
      await user.click(screen.getByLabelText('開発'))
      await user.type(screen.getByLabelText('開始日'), '2025-12-31')
      await user.type(screen.getByLabelText('終了日'), '2025-01-01')
      await user.click(screen.getByRole('button', { name: '登録' }))

      expect(await screen.findByText('終了日は開始日以降の日付を入力してください')).toBeInTheDocument()
    })

    test('WA10201-108: 複数項目エラー - 全エラーメッセージがリスト表示される', async () => {
      const user = userEvent.setup()
      render(<ProjectRegistrationForm onSubmit={mockOnSubmit} />)

      await user.click(screen.getByRole('button', { name: '登録' }))

      const errorList = await screen.findByRole('list', { name: 'エラー一覧' })
      const errors = within(errorList).getAllByRole('listitem')

      expect(errors).toHaveLength(4) // プロジェクト名、種別、開始日、終了日
      expect(screen.getByLabelText('プロジェクト名')).toHaveFocus()
    })

    test('WA10201-109: 二重サブミット防止 - ボタンが非活性化される', async () => {
      const user = userEvent.setup()
      const slowSubmit = jest.fn(() => new Promise(resolve => setTimeout(resolve, 1000)))
      render(<ProjectRegistrationForm onSubmit={slowSubmit} />)

      await user.type(screen.getByLabelText('プロジェクト名'), 'テスト')
      await user.click(screen.getByLabelText('開発'))
      await user.type(screen.getByLabelText('開始日'), '2025-01-01')
      await user.type(screen.getByLabelText('終了日'), '2025-12-31')

      const submitButton = screen.getByRole('button', { name: '登録' })
      await user.click(submitButton)

      // ボタンが非活性化され、ローディング表示
      expect(submitButton).toBeDisabled()
      expect(screen.getByText('登録中...')).toBeInTheDocument()

      // 2回目のクリックは無視される
      await user.click(submitButton)
      expect(slowSubmit).toHaveBeenCalledTimes(1)
    })
  })
})
```

---

## カスタムフックテスト仕様

### useProjectSearch フック

**テストファイル**: `src/hooks/useProjectSearch.test.ts`

```typescript
import { renderHook, waitFor } from '@testing-library/react'
import { useProjectSearch } from './useProjectSearch'

describe('useProjectSearch', () => {
  test('検索クエリを実行してプロジェクトを取得する', async () => {
    const { result } = renderHook(() => useProjectSearch())

    result.current.search({ projectName: 'テスト' })

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false)
      expect(result.current.projects).toHaveLength(3)
    })
  })

  test('エラー時にエラー状態を更新する', async () => {
    const { result } = renderHook(() => useProjectSearch())

    // MSWでエラーレスポンスを返すように設定
    result.current.search({ projectName: 'error' })

    await waitFor(() => {
      expect(result.current.error).toBeTruthy()
      expect(result.current.projects).toEqual([])
    })
  })

  test('検索条件をリセットできる', () => {
    const { result } = renderHook(() => useProjectSearch())

    result.current.search({ projectName: 'テスト', projectType: '開発' })
    result.current.reset()

    expect(result.current.searchParams).toEqual({})
    expect(result.current.projects).toEqual([])
  })
})
```

### useAuth フック

**テストファイル**: `src/hooks/useAuth.test.ts`

```typescript
import { renderHook, waitFor, act } from '@testing-library/react'
import { useAuth } from './useAuth'

describe('useAuth', () => {
  test('ログインが成功する', async () => {
    const { result } = renderHook(() => useAuth())

    await act(async () => {
      await result.current.login('U001', 'password123')
    })

    await waitFor(() => {
      expect(result.current.isAuthenticated).toBe(true)
      expect(result.current.user).toEqual({
        userId: 'U001',
        userName: 'テストユーザー',
      })
    })
  })

  test('ログアウトが成功する', async () => {
    const { result } = renderHook(() => useAuth())

    await act(async () => {
      await result.current.login('U001', 'password123')
      await result.current.logout()
    })

    expect(result.current.isAuthenticated).toBe(false)
    expect(result.current.user).toBeNull()
  })

  test('セッションタイムアウトを検出する', async () => {
    jest.useFakeTimers()
    const { result } = renderHook(() => useAuth())

    await act(async () => {
      await result.current.login('U001', 'password123')
    })

    // 30分経過
    act(() => {
      jest.advanceTimersByTime(30 * 60 * 1000)
    })

    expect(result.current.isAuthenticated).toBe(false)
    expect(result.current.sessionExpired).toBe(true)

    jest.useRealTimers()
  })
})
```

---

## ユーティリティ関数テスト仕様

### バリデーション関数

**テストファイル**: `src/lib/validators.test.ts`

```typescript
import {
  validateProjectName,
  validateDateRange,
  validateRequired,
  sanitizeInput,
} from './validators'

describe('validators', () => {
  describe('validateProjectName', () => {
    test('有効なプロジェクト名を受け入れる', () => {
      expect(validateProjectName('テストプロジェクト')).toBe(true)
    })

    test('空文字列を拒否する', () => {
      const result = validateProjectName('')
      expect(result).toEqual({
        valid: false,
        error: 'プロジェクト名を入力してください',
      })
    })

    test('128文字を超える文字列を拒否する', () => {
      const longName = 'あ'.repeat(129)
      const result = validateProjectName(longName)
      expect(result).toEqual({
        valid: false,
        error: 'プロジェクト名は128文字以内で入力してください',
      })
    })
  })

  describe('validateDateRange', () => {
    test('有効な日付範囲を受け入れる', () => {
      expect(validateDateRange('2025-01-01', '2025-12-31')).toBe(true)
    })

    test('開始日が終了日より後の場合にエラーを返す', () => {
      const result = validateDateRange('2025-12-31', '2025-01-01')
      expect(result).toEqual({
        valid: false,
        error: '終了日は開始日以降の日付を入力してください',
      })
    })

    test('不正な日付形式を拒否する', () => {
      const result = validateDateRange('2025/13/32', '2025-12-31')
      expect(result).toEqual({
        valid: false,
        error: '正しい日付を入力してください',
      })
    })
  })

  describe('sanitizeInput', () => {
    test('XSS攻撃を防ぐためにHTMLタグをエスケープする', () => {
      const malicious = '<script>alert("XSS")</script>'
      const sanitized = sanitizeInput(malicious)
      expect(sanitized).toBe('&lt;script&gt;alert("XSS")&lt;/script&gt;')
    })

    test('SQLインジェクションを防ぐ', () => {
      const malicious = "admin' OR '1'='1"
      const sanitized = sanitizeInput(malicious)
      expect(sanitized).not.toContain("OR '1'='1")
    })
  })
})
```

---

## 結合テスト仕様

### API Route テスト

#### プロジェクト検索API

**テストファイル**: `src/app/api/projects/search/route.test.ts`

```typescript
import { POST } from './route'
import { NextRequest } from 'next/server'

describe('/api/projects/search', () => {
  test('正常系: プロジェクトを検索して返す', async () => {
    const request = new NextRequest('http://localhost:3000/api/projects/search', {
      method: 'POST',
      body: JSON.stringify({ projectName: 'テスト' }),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(200)
    expect(data.projects).toBeDefined()
    expect(data.projects.length).toBeGreaterThan(0)
  })

  test('異常系: 不正なリクエストボディでエラーを返す', async () => {
    const request = new NextRequest('http://localhost:3000/api/projects/search', {
      method: 'POST',
      body: JSON.stringify({ invalid: 'data' }),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(400)
    expect(data.error).toBe('不正なリクエストです')
  })

  test('異常系: データベースエラーで500を返す', async () => {
    // MSWでデータベースエラーをシミュレート
    const request = new NextRequest('http://localhost:3000/api/projects/search', {
      method: 'POST',
      body: JSON.stringify({ projectName: 'db-error' }),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(500)
    expect(data.error).toBe('システムエラーが発生しました')
  })

  test('異常系: 認証エラーで401を返す', async () => {
    const request = new NextRequest('http://localhost:3000/api/projects/search', {
      method: 'POST',
      headers: {
        // セッショントークンなし
      },
      body: JSON.stringify({ projectName: 'テスト' }),
    })

    const response = await POST(request)

    expect(response.status).toBe(401)
  })
})
```

#### プロジェクト登録API

**テストファイル**: `src/app/api/projects/route.test.ts`

```typescript
import { POST } from './route'
import { NextRequest } from 'next/server'

describe('/api/projects', () => {
  test('正常系: プロジェクトを登録する', async () => {
    const projectData = {
      projectName: 'テストプロジェクト',
      projectType: '開発',
      startDate: '2025-01-01',
      endDate: '2025-12-31',
    }

    const request = new NextRequest('http://localhost:3000/api/projects', {
      method: 'POST',
      body: JSON.stringify(projectData),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(201)
    expect(data.projectId).toBeDefined()
    expect(data.message).toBe('登録しました')
  })

  test('異常系: 必須項目不足でバリデーションエラー', async () => {
    const invalidData = {
      projectName: '',
      projectType: '開発',
    }

    const request = new NextRequest('http://localhost:3000/api/projects', {
      method: 'POST',
      body: JSON.stringify(invalidData),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(400)
    expect(data.errors).toContain('プロジェクト名を入力してください')
  })

  test('異常系: 外部キー制約違反でエラー', async () => {
    const projectData = {
      projectName: 'テストプロジェクト',
      projectType: '開発',
      startDate: '2025-01-01',
      endDate: '2025-12-31',
      clientId: 9999, // 存在しない顧客ID
    }

    const request = new NextRequest('http://localhost:3000/api/projects', {
      method: 'POST',
      body: JSON.stringify(projectData),
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(400)
    expect(data.error).toBe('選択された顧客が見つかりません')
  })
})
```

---

### Server Action テスト

#### プロジェクト更新アクション

**テストファイル**: `src/app/actions/project.test.ts`

```typescript
import { updateProject, deleteProject } from './project'

describe('Project Server Actions', () => {
  describe('updateProject', () => {
    test('正常系: プロジェクトを更新する', async () => {
      const result = await updateProject({
        projectId: 1,
        projectName: '更新後プロジェクト',
        version: 1,
      })

      expect(result.success).toBe(true)
      expect(result.message).toBe('更新しました')
    })

    test('異常系: 楽観的排他制御エラー', async () => {
      const result = await updateProject({
        projectId: 1,
        projectName: '更新後プロジェクト',
        version: 0, // 古いバージョン
      })

      expect(result.success).toBe(false)
      expect(result.error).toBe('このプロジェクトは他のユーザーによって更新されています。画面を再読み込みしてください')
    })

    test('異常系: 存在しないプロジェクトID', async () => {
      const result = await updateProject({
        projectId: 9999,
        projectName: '更新後プロジェクト',
        version: 1,
      })

      expect(result.success).toBe(false)
      expect(result.error).toBe('プロジェクトが見つかりません')
    })
  })

  describe('deleteProject', () => {
    test('正常系: プロジェクトを論理削除する', async () => {
      const result = await deleteProject(1)

      expect(result.success).toBe(true)
      expect(result.message).toBe('削除しました')
    })

    test('異常系: 削除済みプロジェクト', async () => {
      const result = await deleteProject(5) // 削除済みID

      expect(result.success).toBe(false)
      expect(result.error).toBe('このプロジェクトは削除されています')
    })
  })
})
```

---

## E2Eテスト仕様

### Playwright設定

**playwright.config.ts**

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

---

### ログインフロー E2E テスト

**テストファイル**: `e2e/auth/login.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('ログイン機能', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
  })

  test('WA10101-E2E-001: 正常ログイン - TOP画面に遷移する', async ({ page }) => {
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')

    // TOP画面に遷移
    await expect(page).toHaveURL('/dashboard')
    await expect(page.locator('h1')).toContainText('TOP')

    // ユーザー名が表示される
    await expect(page.locator('text=テストユーザー')).toBeVisible()
  })

  test('WA10101-E2E-002: ログイン失敗 - エラーメッセージが表示される', async ({ page }) => {
    await page.fill('input[name="userId"]', 'INVALID')
    await page.fill('input[name="password"]', 'wrongpassword')
    await page.click('button:has-text("ログイン")')

    // エラーメッセージの表示
    await expect(page.locator('text=ユーザーIDまたはパスワードが正しくありません')).toBeVisible()

    // ログイン画面に留まる
    await expect(page).toHaveURL('/login')
  })

  test('WA10101-E2E-003: アカウントロック - ログインボタンが無効化される', async ({ page }) => {
    // 5回ログイン失敗
    for (let i = 0; i < 5; i++) {
      await page.fill('input[name="userId"]', 'U001')
      await page.fill('input[name="password"]', 'wrongpassword')
      await page.click('button:has-text("ログイン")')
      await page.waitForTimeout(500)
    }

    // アカウントロックメッセージ
    await expect(page.locator('text=アカウントがロックされています')).toBeVisible()

    // ログインボタンが無効化
    await expect(page.locator('button:has-text("ログイン")')).toBeDisabled()
  })

  test('WA10102-E2E-001: ログアウト - ログイン画面に遷移する', async ({ page }) => {
    // ログイン
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')
    await expect(page).toHaveURL('/dashboard')

    // ログアウト
    await page.click('button:has-text("ログアウト")')

    // 確認ダイアログ
    page.on('dialog', dialog => dialog.accept())

    // ログイン画面に遷移
    await expect(page).toHaveURL('/login')
    await expect(page.locator('text=ログアウトしました')).toBeVisible()
  })

  test('WA10103-E2E-001: セッションタイムアウト - ログイン画面にリダイレクト', async ({ page }) => {
    // ログイン
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')

    // セッションを削除してタイムアウトをシミュレート
    await page.context().clearCookies()

    // 保護されたページにアクセス
    await page.goto('/projects')

    // ログイン画面にリダイレクト
    await expect(page).toHaveURL('/login')
    await expect(page.locator('text=セッションがタイムアウトしました')).toBeVisible()
  })
})
```

---

### プロジェクト検索 E2E テスト

**テストファイル**: `e2e/project/search.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('プロジェクト検索機能', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン
    await page.goto('/login')
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')
    await expect(page).toHaveURL('/dashboard')

    // プロジェクト検索画面へ遷移
    await page.click('text=プロジェクト検索')
    await expect(page).toHaveURL('/projects/search')
  })

  test('プロジェクト名で検索できる', async ({ page }) => {
    await page.fill('input[name="projectName"]', 'テスト')
    await page.click('button:has-text("検索")')

    // 検索結果が表示される
    await expect(page.locator('table')).toBeVisible()
    await expect(page.locator('tbody tr')).toHaveCount(3)

    // 各行にプロジェクト名が含まれる
    const rows = page.locator('tbody tr')
    for (let i = 0; i < 3; i++) {
      await expect(rows.nth(i)).toContainText('テスト')
    }
  })

  test('プロジェクト種別でフィルタリングできる', async ({ page }) => {
    await page.selectOption('select[name="projectType"]', '開発')
    await page.click('button:has-text("検索")')

    // 開発プロジェクトのみ表示
    const rows = page.locator('tbody tr')
    const count = await rows.count()

    for (let i = 0; i < count; i++) {
      await expect(rows.nth(i).locator('td').nth(2)).toContainText('開発')
    }
  })

  test('日付範囲で検索できる', async ({ page }) => {
    await page.fill('input[name="startDateFrom"]', '2025-01-01')
    await page.fill('input[name="startDateTo"]', '2025-03-31')
    await page.click('button:has-text("検索")')

    // 結果が表示される
    await expect(page.locator('tbody tr')).toHaveCount(2)
  })

  test('検索結果からプロジェクト詳細に遷移できる', async ({ page }) => {
    await page.fill('input[name="projectName"]', 'プロジェクトA')
    await page.click('button:has-text("検索")')

    // 最初の行をクリック
    await page.click('tbody tr:first-child')

    // 詳細画面に遷移
    await expect(page).toHaveURL(/\/projects\/\d+/)
    await expect(page.locator('h1')).toContainText('プロジェクト詳細')
    await expect(page.locator('text=プロジェクトA')).toBeVisible()
  })

  test('検索結果が0件の場合にメッセージが表示される', async ({ page }) => {
    await page.fill('input[name="projectName"]', '存在しないプロジェクト')
    await page.click('button:has-text("検索")')

    await expect(page.locator('text=該当するデータが見つかりません')).toBeVisible()
    await expect(page.locator('tbody tr')).toHaveCount(0)
  })

  test('ページネーションが動作する', async ({ page }) => {
    // 検索実行（100件のデータがあると仮定）
    await page.click('button:has-text("検索")')

    // 1ページ目の表示確認
    await expect(page.locator('tbody tr')).toHaveCount(10)
    await expect(page.locator('text=1 / 10 ページ')).toBeVisible()

    // 次のページへ移動
    await page.click('button:has-text("次へ")')
    await expect(page.locator('text=2 / 10 ページ')).toBeVisible()

    // 前のページへ移動
    await page.click('button:has-text("前へ")')
    await expect(page.locator('text=1 / 10 ページ')).toBeVisible()
  })
})
```

---

### プロジェクト登録 E2E テスト

**テストファイル**: `e2e/project/registration.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('プロジェクト登録機能', () => {
  test.beforeEach(async ({ page }) => {
    // PMユーザーでログイン
    await page.goto('/login')
    await page.fill('input[name="userId"]', 'U002')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')

    // プロジェクト登録画面へ遷移
    await page.click('text=プロジェクト登録')
    await expect(page).toHaveURL('/projects/new')
  })

  test('WA10201-E2E-001: プロジェクトを新規登録できる', async ({ page }) => {
    // 必須項目を入力
    await page.fill('input[name="projectName"]', 'E2Eテストプロジェクト')
    await page.check('input[value="開発"]')
    await page.fill('input[name="startDate"]', '2025-06-01')
    await page.fill('input[name="endDate"]', '2025-12-31')

    // 登録ボタンをクリック
    await page.click('button:has-text("登録")')

    // 成功メッセージの表示
    await expect(page.locator('text=登録しました')).toBeVisible()

    // 詳細画面に遷移
    await expect(page).toHaveURL(/\/projects\/\d+/)
    await expect(page.locator('text=E2Eテストプロジェクト')).toBeVisible()
  })

  test('WA10201-E2E-002: 顧客選択モーダルで顧客を選択できる', async ({ page }) => {
    // 顧客選択ボタンをクリック
    await page.click('button:has-text("顧客選択")')

    // モーダルが開く
    const modal = page.locator('role=dialog')
    await expect(modal).toBeVisible()

    // 顧客名で検索
    await modal.locator('input[name="clientName"]').fill('テスト商事')
    await modal.locator('button:has-text("検索")').click()

    // 検索結果から選択
    await modal.locator('text=株式会社テスト商事').click()
    await modal.locator('button:has-text("選択")').click()

    // モーダルが閉じて顧客名が設定される
    await expect(modal).not.toBeVisible()
    await expect(page.locator('input[name="clientName"]')).toHaveValue('株式会社テスト商事')
    await expect(page.locator('input[name="clientName"]')).toHaveAttribute('readonly')
  })

  test('WA10201-E2E-003: バリデーションエラーが表示される', async ({ page }) => {
    // 必須項目を空のまま登録ボタンをクリック
    await page.click('button:has-text("登録")')

    // エラーメッセージが表示される
    await expect(page.locator('text=プロジェクト名を入力してください')).toBeVisible()
    await expect(page.locator('text=プロジェクト種別を選択してください')).toBeVisible()
    await expect(page.locator('text=開始日を入力してください')).toBeVisible()
    await expect(page.locator('text=終了日を入力してください')).toBeVisible()

    // 最初のエラー項目にフォーカス
    await expect(page.locator('input[name="projectName"]')).toBeFocused()
  })

  test('WA10201-E2E-004: 日付の前後関係エラーが表示される', async ({ page }) => {
    await page.fill('input[name="projectName"]', 'テスト')
    await page.check('input[value="開発"]')
    await page.fill('input[name="startDate"]', '2025-12-31')
    await page.fill('input[name="endDate"]', '2025-01-01')
    await page.click('button:has-text("登録")')

    await expect(page.locator('text=終了日は開始日以降の日付を入力してください')).toBeVisible()
  })

  test('WA10201-E2E-005: クリアボタンで入力値がリセットされる', async ({ page }) => {
    // 項目に値を入力
    await page.fill('input[name="projectName"]', 'テスト')
    await page.check('input[value="開発"]')
    await page.fill('input[name="startDate"]', '2025-01-01')

    // クリアボタンをクリック
    await page.click('button:has-text("クリア")')

    // 確認ダイアログで「OK」を選択
    page.once('dialog', dialog => {
      expect(dialog.message()).toBe('入力内容をクリアしますか?')
      dialog.accept()
    })

    // 入力値がクリアされる
    await expect(page.locator('input[name="projectName"]')).toHaveValue('')
    await expect(page.locator('input[name="startDate"]')).toHaveValue('')

    // フォーカスがプロジェクト名に移動
    await expect(page.locator('input[name="projectName"]')).toBeFocused()
  })

  test('WA10201-E2E-006: 二重送信が防止される', async ({ page }) => {
    await page.fill('input[name="projectName"]', 'テスト')
    await page.check('input[value="開発"]')
    await page.fill('input[name="startDate"]', '2025-01-01')
    await page.fill('input[name="endDate"]', '2025-12-31')

    // 登録ボタンを連続クリック
    const submitButton = page.locator('button:has-text("登録")')
    await submitButton.click()
    await submitButton.click()
    await submitButton.click()

    // ボタンが無効化される
    await expect(submitButton).toBeDisabled()

    // ローディング表示
    await expect(page.locator('text=登録中...')).toBeVisible()

    // 1回だけ登録される（APIリクエスト回数を確認）
    // 成功メッセージは1回だけ
    await expect(page.locator('text=登録しました')).toHaveCount(1)
  })
})
```

---

### プロジェクト更新・削除 E2E テスト

**テストファイル**: `e2e/project/update-delete.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('プロジェクト更新・削除機能', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン
    await page.goto('/login')
    await page.fill('input[name="userId"]', 'U002')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')

    // プロジェクト詳細画面へ遷移（プロジェクトID=1）
    await page.goto('/projects/1')
  })

  test('WA10202-E2E-001: プロジェクト詳細が表示される', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('プロジェクト詳細')
    await expect(page.locator('text=プロジェクトA')).toBeVisible()

    // 読み取り専用で表示
    await expect(page.locator('input[name="projectName"]')).toHaveAttribute('readonly')

    // ボタンが表示される
    await expect(page.locator('button:has-text("更新")')).toBeVisible()
    await expect(page.locator('button:has-text("削除")')).toBeVisible()
    await expect(page.locator('button:has-text("戻る")')).toBeVisible()
  })

  test('WA10203-E2E-001: プロジェクトを更新できる', async ({ page }) => {
    // 更新ボタンをクリック
    await page.click('button:has-text("更新")')

    // 更新画面に遷移
    await expect(page).toHaveURL('/projects/1/edit')

    // 項目が編集可能
    const projectNameInput = page.locator('input[name="projectName"]')
    await expect(projectNameInput).not.toHaveAttribute('readonly')

    // プロジェクト名を変更
    await projectNameInput.clear()
    await projectNameInput.fill('プロジェクトA（更新版）')

    // 更新ボタンをクリック
    await page.click('button:has-text("更新")')

    // 成功メッセージ
    await expect(page.locator('text=更新しました')).toBeVisible()

    // 詳細画面に遷移して更新内容が反映されている
    await expect(page).toHaveURL('/projects/1')
    await expect(page.locator('text=プロジェクトA（更新版）')).toBeVisible()
  })

  test('WA10203-E2E-002: 楽観的排他制御エラーが検出される', async ({ page }) => {
    // 更新画面へ遷移
    await page.click('button:has-text("更新")')
    await expect(page).toHaveURL('/projects/1/edit')

    // 別ブラウザで同じプロジェクトを更新（シミュレート）
    const context2 = await page.context().browser()!.newContext()
    const page2 = await context2.newPage()
    await page2.goto('/login')
    await page2.fill('input[name="userId"]', 'U002')
    await page2.fill('input[name="password"]', 'password123')
    await page2.click('button:has-text("ログイン")')
    await page2.goto('/projects/1/edit')
    await page2.fill('input[name="projectName"]', 'プロジェクトA（別ユーザー更新）')
    await page2.click('button:has-text("更新")')
    await page2.close()

    // 最初のブラウザで更新を試みる
    await page.fill('input[name="projectName"]', 'プロジェクトA（更新版）')
    await page.click('button:has-text("更新")')

    // 楽観的排他制御エラー
    await expect(page.locator('text=このプロジェクトは他のユーザーによって更新されています')).toBeVisible()
    await expect(page.locator('button:has-text("再読込")')).toBeVisible()
  })

  test('WA10202-E2E-002: プロジェクトを削除できる', async ({ page }) => {
    // 削除ボタンをクリック
    await page.click('button:has-text("削除")')

    // 確認ダイアログ
    page.once('dialog', dialog => {
      expect(dialog.message()).toContain('削除してもよろしいですか')
      dialog.accept()
    })

    // 削除成功メッセージ
    await expect(page.locator('text=削除しました')).toBeVisible()

    // 検索画面に遷移
    await expect(page).toHaveURL('/projects/search')
  })

  test('WA10202-E2E-003: 削除をキャンセルできる', async ({ page }) => {
    // 削除ボタンをクリック
    await page.click('button:has-text("削除")')

    // 確認ダイアログでキャンセル
    page.once('dialog', dialog => {
      dialog.dismiss()
    })

    // 詳細画面に留まる
    await expect(page).toHaveURL('/projects/1')
    await expect(page.locator('text=プロジェクトA')).toBeVisible()
  })

  test('WA10203-E2E-003: 更新をキャンセルできる', async ({ page }) => {
    await page.click('button:has-text("更新")')

    // 項目を変更
    await page.fill('input[name="projectName"]', '変更後')

    // キャンセルボタンをクリック
    await page.click('button:has-text("キャンセル")')

    // 確認ダイアログ
    page.once('dialog', dialog => {
      expect(dialog.message()).toContain('変更内容を破棄しますか')
      dialog.accept()
    })

    // 詳細画面に戻り、変更が破棄される
    await expect(page).toHaveURL('/projects/1')
    await expect(page.locator('text=プロジェクトA')).toBeVisible()
    await expect(page.locator('text=変更後')).not.toBeVisible()
  })
})
```

---

### アクセシビリティテスト

**テストファイル**: `e2e/accessibility/a11y.spec.ts`

```typescript
import { test, expect } from '@playwright/test'
import AxeBuilder from '@axe-core/playwright'

test.describe('アクセシビリティ', () => {
  test('ログイン画面がWCAG 2.1 AAに準拠している', async ({ page }) => {
    await page.goto('/login')

    const accessibilityScanResults = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
      .analyze()

    expect(accessibilityScanResults.violations).toEqual([])
  })

  test('プロジェクト検索画面がWCAG 2.1 AAに準拠している', async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button:has-text("ログイン")')

    await page.goto('/projects/search')

    const accessibilityScanResults = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
      .analyze()

    expect(accessibilityScanResults.violations).toEqual([])
  })

  test('キーボードナビゲーションが動作する', async ({ page }) => {
    await page.goto('/login')

    // Tabキーでフォーカス移動
    await page.keyboard.press('Tab')
    await expect(page.locator('input[name="userId"]')).toBeFocused()

    await page.keyboard.press('Tab')
    await expect(page.locator('input[name="password"]')).toBeFocused()

    await page.keyboard.press('Tab')
    await expect(page.locator('button:has-text("ログイン")')).toBeFocused()

    // Enterキーでボタンをクリック
    await page.fill('input[name="userId"]', 'U001')
    await page.fill('input[name="password"]', 'password123')
    await page.keyboard.press('Enter')

    await expect(page).toHaveURL('/dashboard')
  })

  test('スクリーンリーダー用のラベルが適切に設定されている', async ({ page }) => {
    await page.goto('/projects/new')

    // ARIAラベルの確認
    await expect(page.locator('input[name="projectName"]')).toHaveAttribute('aria-label', 'プロジェクト名')
    await expect(page.locator('input[name="startDate"]')).toHaveAttribute('aria-label', '開始日')

    // エラーメッセージとの関連付け
    await page.click('button:has-text("登録")')
    await expect(page.locator('input[name="projectName"]')).toHaveAttribute('aria-invalid', 'true')
    await expect(page.locator('input[name="projectName"]')).toHaveAttribute('aria-describedby')
  })
})
```

---

## テストデータ

### MSW (Mock Service Worker) セットアップ

**src/mocks/handlers.ts**

```typescript
import { http, HttpResponse } from 'msw'

export const handlers = [
  // ログインAPI
  http.post('/api/auth/login', async ({ request }) => {
    const { userId, password } = await request.json()

    if (userId === 'U001' && password === 'password123') {
      return HttpResponse.json({
        success: true,
        user: {
          userId: 'U001',
          userName: 'テストユーザー',
          role: 'ROLE_USER',
        },
        sessionId: 'mock-session-id',
      })
    }

    if (userId === 'U999') {
      return HttpResponse.json(
        { error: 'このアカウントは無効です' },
        { status: 401 }
      )
    }

    return HttpResponse.json(
      { error: 'ユーザーIDまたはパスワードが正しくありません' },
      { status: 401 }
    )
  }),

  // プロジェクト検索API
  http.post('/api/projects/search', async ({ request }) => {
    const searchParams = await request.json()

    const projects = [
      {
        projectId: 1,
        projectName: 'プロジェクトA',
        projectType: '開発',
        startDate: '2025-01-01',
        endDate: '2025-12-31',
        clientName: '株式会社テスト商事',
      },
      {
        projectId: 2,
        projectName: 'テストプロジェクトB',
        projectType: '保守',
        startDate: '2025-02-01',
        endDate: '2025-11-30',
        clientName: '山田商会',
      },
      {
        projectId: 3,
        projectName: 'テストプロジェクトC',
        projectType: '開発',
        startDate: '2025-03-01',
        endDate: '2025-10-31',
        clientName: '鈴木産業株式会社',
      },
    ]

    // プロジェクト名でフィルタ
    let filtered = projects
    if (searchParams.projectName) {
      filtered = filtered.filter(p =>
        p.projectName.includes(searchParams.projectName)
      )
    }

    // プロジェクト種別でフィルタ
    if (searchParams.projectType) {
      filtered = filtered.filter(p => p.projectType === searchParams.projectType)
    }

    return HttpResponse.json({ projects: filtered })
  }),

  // プロジェクト登録API
  http.post('/api/projects', async ({ request }) => {
    const projectData = await request.json()

    // バリデーション
    if (!projectData.projectName) {
      return HttpResponse.json(
        { errors: ['プロジェクト名を入力してください'] },
        { status: 400 }
      )
    }

    // 外部キー制約チェック
    if (projectData.clientId === 9999) {
      return HttpResponse.json(
        { error: '選択された顧客が見つかりません' },
        { status: 400 }
      )
    }

    return HttpResponse.json({
      projectId: 100,
      message: '登録しました',
    }, { status: 201 })
  }),

  // プロジェクト詳細取得API
  http.get('/api/projects/:id', ({ params }) => {
    const { id } = params

    if (id === '1') {
      return HttpResponse.json({
        projectId: 1,
        projectName: 'プロジェクトA',
        projectType: '開発',
        startDate: '2025-01-01',
        endDate: '2025-12-31',
        clientId: 1,
        clientName: '株式会社テスト商事',
        pmId: 2,
        pmName: '田中太郎',
        remarks: '備考A',
        version: 1,
      })
    }

    return HttpResponse.json(
      { error: 'プロジェクトが見つかりません' },
      { status: 404 }
    )
  }),

  // プロジェクト更新API
  http.put('/api/projects/:id', async ({ params, request }) => {
    const { id } = params
    const updateData = await request.json()

    // 楽観的排他制御チェック
    if (updateData.version === 0) {
      return HttpResponse.json(
        { error: 'このプロジェクトは他のユーザーによって更新されています。画面を再読み込みしてください' },
        { status: 409 }
      )
    }

    return HttpResponse.json({
      message: '更新しました',
    })
  }),

  // プロジェクト削除API
  http.delete('/api/projects/:id', ({ params }) => {
    const { id } = params

    if (id === '5') {
      return HttpResponse.json(
        { error: 'このプロジェクトは削除されています' },
        { status: 400 }
      )
    }

    return HttpResponse.json({
      message: '削除しました',
    })
  }),

  // 顧客検索API
  http.post('/api/clients/search', async ({ request }) => {
    const { clientName } = await request.json()

    const clients = [
      { clientId: 1, clientCode: 'C001', clientName: '株式会社テスト商事' },
      { clientId: 2, clientCode: 'C002', clientName: '山田商会' },
      { clientId: 3, clientCode: 'C003', clientName: '鈴木産業株式会社' },
    ]

    const filtered = clientName
      ? clients.filter(c => c.clientName.includes(clientName))
      : clients

    return HttpResponse.json({ clients: filtered })
  }),
]
```

**src/mocks/server.ts**

```typescript
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
```

**src/mocks/browser.ts**

```typescript
import { setupWorker } from 'msw/browser'
import { handlers } from './handlers'

export const worker = setupWorker(...handlers)
```

---

### テストフィクスチャ

**src/test/fixtures/projects.ts**

```typescript
export const mockProjects = [
  {
    projectId: 1,
    projectName: 'プロジェクトA',
    projectType: '開発',
    startDate: '2025-01-01',
    endDate: '2025-12-31',
    clientId: 1,
    clientName: '株式会社テスト商事',
    pmId: 2,
    pmName: '田中太郎',
    remarks: '備考A',
    deleteFlag: false,
    createdAt: '2025-01-01T00:00:00Z',
    updatedAt: '2025-01-01T00:00:00Z',
    version: 1,
  },
  {
    projectId: 2,
    projectName: 'プロジェクトB',
    projectType: '保守',
    startDate: '2025-02-01',
    endDate: '2025-11-30',
    clientId: 2,
    clientName: '山田商会',
    pmId: 2,
    pmName: '田中太郎',
    remarks: '備考B',
    deleteFlag: false,
    createdAt: '2025-02-01T00:00:00Z',
    updatedAt: '2025-02-01T00:00:00Z',
    version: 1,
  },
  {
    projectId: 5,
    projectName: '削除済みプロジェクト',
    projectType: '開発',
    startDate: '2025-05-01',
    endDate: '2025-08-31',
    clientId: 2,
    clientName: '山田商会',
    pmId: 2,
    pmName: '田中太郎',
    remarks: '削除済み',
    deleteFlag: true,
    createdAt: '2025-05-01T00:00:00Z',
    updatedAt: '2025-05-15T00:00:00Z',
    version: 1,
  },
]

export const mockClients = [
  { clientId: 1, clientCode: 'C001', clientName: '株式会社テスト商事', deleteFlag: false },
  { clientId: 2, clientCode: 'C002', clientName: '山田商会', deleteFlag: false },
  { clientId: 3, clientCode: 'C003', clientName: '鈴木産業株式会社', deleteFlag: false },
]

export const mockUsers = [
  {
    userId: 1,
    userCode: 'U001',
    loginId: 'test_user',
    userName: 'テストユーザー',
    role: 'ROLE_USER',
    deleteFlag: false,
  },
  {
    userId: 2,
    userCode: 'U002',
    loginId: 'pm_user',
    userName: '田中太郎',
    role: 'ROLE_PM',
    deleteFlag: false,
  },
  {
    userId: 999,
    userCode: 'U999',
    loginId: 'deleted_user',
    userName: '削除済みユーザー',
    role: 'ROLE_USER',
    deleteFlag: true,
  },
]
```

---

## テスト環境

### ハードウェア要件

| 項目 | 要件 |
|------|------|
| CPU | Intel Core i5以上(2.0GHz以上) |
| メモリ | 8GB以上 |
| ディスク容量 | 50GB以上の空き容量 |
| ネットワーク | 100Mbps以上 |

### ソフトウェア要件

| 項目 | バージョン |
|------|-----------|
| OS | Windows 10/11、macOS 12以降、Ubuntu 20.04以降 |
| Node.js | 18.17以上 |
| Next.js | 14.0以上 |
| データベース | PostgreSQL 15 |
| Webブラウザ | Chrome 最新版、Firefox 最新版、Safari 最新版 |

### テストデータベース設定

```bash
# 環境変数 (.env.test)
DATABASE_URL="postgresql://testuser:testpass123@localhost:5432/project_management_test"
NEXTAUTH_SECRET="test-secret-key"
NEXTAUTH_URL="http://localhost:3000"
```

### テスト実行コマンド

```bash
# 単体テスト実行
npm run test

# 単体テスト（ウォッチモード）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage

# E2Eテスト実行
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui

# 全テスト実行
npm run test:all
```

---

## テスト完了基準

1. **単体テスト**: 全てのコンポーネント、フック、ユーティリティ関数のテストケースが合格
2. **結合テスト**: 全てのAPI RouteとServer Actionのテストケースが合格
3. **E2Eテスト**: 全ての主要なユーザーフローのテストケースが合格
4. **不具合**: 致命的(Critical)および重大(Major)な不具合が0件
5. **カバレッジ**: コードカバレッジ80%以上
   - ブランチカバレッジ: 80%以上
   - 関数カバレッジ: 80%以上
   - ラインカバレッジ: 80%以上
6. **アクセシビリティ**: WCAG 2.1 AAレベルに準拠
7. **性能**: 全ての性能要件を満たす

---

## 改版履歴

| バージョン | 改版日 | 改版内容 | 承認者 |
|-----------|--------|---------|--------|
| 1.0 | 2025-11-27 | 初版作成（Spring/JUnit版） | - |
| 2.0 | 2025-11-27 | Next.js/Jest/Playwright版に全面改訂 | - |

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| テスト責任者 | | | |
| 品質管理責任者 | | | |
| プロジェクトマネージャー | | | |

---

**文書終了**
