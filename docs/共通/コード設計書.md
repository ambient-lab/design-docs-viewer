# コード設計書

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | コード設計書 |
| 対象システム | A1システム、B1システム共通 |
| 作成日 | 2025-11-27 |
| 版数 | 1.0 |

## 2. 目的

本書は、A1システムおよびB1システムで使用する共通コード値の定義、管理方針、テーブル設計について規定する。

## 3. 共通コード定義

### 3.1 ステータスコード

全システム共通で使用する汎用的なステータスコード。

| コード値 | コード名 | 説明 | 備考 |
|----------|----------|------|------|
| 01 | 有効 | 有効な状態 | デフォルト値 |
| 02 | 無効 | 無効な状態 | 一時的な無効化 |
| 99 | 削除 | 論理削除状態 | 物理削除は行わない |

**適用対象:**
- マスタデータ全般
- 設定情報
- その他有効/無効の管理が必要なデータ

### 3.2 プロジェクトステータスコード

プロジェクト管理で使用するステータスコード。

| コード値 | コード名 | 説明 | 遷移可能状態 | 備考 |
|----------|----------|------|--------------|------|
| 10 | 計画中 | プロジェクト計画段階 | 20, 40 | 初期状態 |
| 20 | 進行中 | プロジェクト実行中 | 30, 40 | 作業中 |
| 30 | 完了 | プロジェクト完了 | - | 終了状態 |
| 40 | 中止 | プロジェクト中止 | - | 終了状態 |

**ステータス遷移図:**
```
10(計画中) → 20(進行中) → 30(完了)
    ↓            ↓
    40(中止) ←---
```

**適用対象:**
- A1システム: プロジェクトテーブル
- B1システム: 案件管理テーブル

### 3.3 顧客ステータスコード

顧客管理で使用するステータスコード。

| コード値 | コード名 | 説明 | 遷移可能状態 | 備考 |
|----------|----------|------|--------------|------|
| 01 | アクティブ | 通常取引可能状態 | 02, 09 | 通常状態 |
| 02 | 休止 | 一時的な取引停止 | 01, 09 | 再開可能 |
| 09 | 退会 | 契約終了 | - | 終了状態 |

**ステータス遷移図:**
```
01(アクティブ) ⇄ 02(休止)
    ↓              ↓
    09(退会) ←-----
```

**適用対象:**
- A1システム: 顧客マスタ
- B1システム: 取引先マスタ

### 3.4 その他の共通コード

#### 3.4.1 性別コード

| コード値 | コード名 | 備考 |
|----------|----------|------|
| 1 | 男性 | |
| 2 | 女性 | |
| 9 | その他 | |

#### 3.4.2 都道府県コード

| コード値 | コード名 | 備考 |
|----------|----------|------|
| 01 | 北海道 | JIS X 0401準拠 |
| 02 | 青森県 | |
| ... | ... | |
| 47 | 沖縄県 | |

**注:** 詳細は「都道府県コードマスタ」を参照。

#### 3.4.3 優先度コード

| コード値 | コード名 | 説明 | 備考 |
|----------|----------|------|------|
| 1 | 低 | 優先度低 | |
| 2 | 中 | 優先度中 | デフォルト値 |
| 3 | 高 | 優先度高 | |
| 9 | 緊急 | 最優先 | |

## 4. コード管理方針

### 4.1 コード命名規則

#### 4.1.1 コードカテゴリ命名規則

| 規則 | 説明 | 例 |
|------|------|-----|
| 英数字のみ | 半角英数字とアンダースコアのみ使用 | `STATUS_CODE` |
| 大文字表記 | すべて大文字で記述 | `PROJECT_STATUS` |
| 意味明確性 | カテゴリ内容が明確に分かる名称 | `CUSTOMER_STATUS` |
| 接尾辞統一 | ステータス系は`_STATUS`、区分系は`_TYPE` | `PAYMENT_TYPE` |

#### 4.1.2 コード値命名規則

| 項目 | 規則 | 備考 |
|------|------|------|
| 桁数 | 2桁または3桁固定 | カテゴリ内で統一 |
| 形式 | 数値文字列（ゼロパディング） | '01', '02', ... |
| 予約値 | 00: 未設定、99: その他/削除 | 特別な意味を持つ |
| 範囲 | 01-98: 通常値、99: 特殊値 | 拡張性を考慮 |

### 4.2 バージョン管理

#### 4.2.1 コード追加時の管理

| 手順 | 内容 | 責任者 |
|------|------|--------|
| 1 | コード追加申請書の作成 | 開発担当者 |
| 2 | 既存コードとの整合性確認 | システムアーキテクト |
| 3 | コードマスタへの登録 | データベース管理者 |
| 4 | 設計書の更新 | 開発担当者 |
| 5 | レビューと承認 | プロジェクトマネージャー |

#### 4.2.2 コード変更時の管理

| 変更種別 | 対応方針 | 備考 |
|----------|----------|------|
| コード名変更 | 可能（UPDATE） | 既存データに影響なし |
| コード値変更 | 原則不可 | 新規コード追加を推奨 |
| コード削除 | 論理削除のみ（valid_flag=0） | 物理削除は禁止 |
| カテゴリ変更 | 原則不可 | 新規カテゴリ作成を推奨 |

### 4.3 拡張ガイドライン

#### 4.3.1 コード追加の判断基準

新規コードを追加する場合、以下の基準を満たすこと:

1. **必要性**: 既存コードでは表現できない明確な要件がある
2. **汎用性**: 複数の機能や画面で使用される可能性がある
3. **永続性**: 一時的な要件ではなく、長期的に使用される
4. **整合性**: 既存のコード体系と矛盾しない

#### 4.3.2 システム固有コードの管理

| 項目 | 管理方針 |
|------|----------|
| 共通コード | code_masterテーブルで一元管理 |
| システム固有コード | 各システムのカテゴリとして管理（category_prefixで識別） |
| プロジェクト固有コード | 個別テーブルで管理（code_masterは使用しない） |

**カテゴリ接頭辞ルール:**
- `CMN_`: 全システム共通
- `A1_`: A1システム固有
- `B1_`: B1システム固有

## 5. コードテーブル設計

### 5.1 コードマスタテーブル（code_master）

#### 5.1.1 テーブル定義

| 物理名 | 論理名 | データ型 | 桁数 | NULL | PK | デフォルト値 | 備考 |
|--------|--------|----------|------|------|----|-----------|----|
| code_category | コードカテゴリ | VARCHAR | 50 | NOT NULL | ○ | - | カテゴリ識別子 |
| code_value | コード値 | VARCHAR | 10 | NOT NULL | ○ | - | コード値 |
| code_name | コード名 | VARCHAR | 100 | NOT NULL | | - | 表示名称 |
| code_name_en | コード名（英語） | VARCHAR | 100 | NULL | | - | 英語表示名 |
| description | 説明 | VARCHAR | 500 | NULL | | - | 詳細説明 |
| display_order | 表示順序 | INT | - | NOT NULL | | 0 | 昇順でソート |
| valid_flag | 有効フラグ | CHAR | 1 | NOT NULL | | '1' | 1=有効, 0=無効 |
| parent_code_value | 親コード値 | VARCHAR | 10 | NULL | | - | 階層構造用 |
| attribute1 | 属性1 | VARCHAR | 100 | NULL | | - | 拡張属性 |
| attribute2 | 属性2 | VARCHAR | 100 | NULL | | - | 拡張属性 |
| attribute3 | 属性3 | VARCHAR | 100 | NULL | | - | 拡張属性 |
| created_at | 作成日時 | TIMESTAMP | - | NOT NULL | | CURRENT_TIMESTAMP | |
| created_by | 作成者 | VARCHAR | 50 | NOT NULL | | - | ユーザーID |
| updated_at | 更新日時 | TIMESTAMP | - | NOT NULL | | CURRENT_TIMESTAMP | |
| updated_by | 更新者 | VARCHAR | 50 | NOT NULL | | - | ユーザーID |

**主キー:** (code_category, code_value)

#### 5.1.2 インデックス定義

| インデックス名 | カラム | 種別 | 備考 |
|----------------|--------|------|------|
| PK_CODE_MASTER | code_category, code_value | PRIMARY KEY | |
| IDX_CODE_MASTER_01 | code_category, display_order | INDEX | 表示順ソート用 |
| IDX_CODE_MASTER_02 | code_category, valid_flag | INDEX | 有効データ抽出用 |

#### 5.1.3 制約定義

| 制約名 | 種別 | 内容 |
|--------|------|------|
| CHK_CODE_MASTER_VALID_FLAG | CHECK | valid_flag IN ('0', '1') |
| CHK_CODE_MASTER_DISPLAY_ORDER | CHECK | display_order >= 0 |

### 5.2 データ登録例

#### 5.2.1 ステータスコード登録例

```sql
-- ステータスコード
INSERT INTO code_master (code_category, code_value, code_name, code_name_en, description, display_order, valid_flag, created_by, updated_by)
VALUES
('CMN_STATUS', '01', '有効', 'Active', '有効な状態', 1, '1', 'SYSTEM', 'SYSTEM'),
('CMN_STATUS', '02', '無効', 'Inactive', '無効な状態', 2, '1', 'SYSTEM', 'SYSTEM'),
('CMN_STATUS', '99', '削除', 'Deleted', '論理削除状態', 99, '1', 'SYSTEM', 'SYSTEM');
```

#### 5.2.2 プロジェクトステータス登録例

```sql
-- プロジェクトステータス
INSERT INTO code_master (code_category, code_value, code_name, code_name_en, description, display_order, valid_flag, attribute1, created_by, updated_by)
VALUES
('CMN_PROJECT_STATUS', '10', '計画中', 'Planning', 'プロジェクト計画段階', 1, '1', '20,40', 'SYSTEM', 'SYSTEM'),
('CMN_PROJECT_STATUS', '20', '進行中', 'In Progress', 'プロジェクト実行中', 2, '1', '30,40', 'SYSTEM', 'SYSTEM'),
('CMN_PROJECT_STATUS', '30', '完了', 'Completed', 'プロジェクト完了', 3, '1', NULL, 'SYSTEM', 'SYSTEM'),
('CMN_PROJECT_STATUS', '40', '中止', 'Cancelled', 'プロジェクト中止', 4, '1', NULL, 'SYSTEM', 'SYSTEM');
```

**注:** attribute1には遷移可能な次ステータスをカンマ区切りで格納。

#### 5.2.3 顧客ステータス登録例

```sql
-- 顧客ステータス
INSERT INTO code_master (code_category, code_value, code_name, code_name_en, description, display_order, valid_flag, attribute1, created_by, updated_by)
VALUES
('CMN_CUSTOMER_STATUS', '01', 'アクティブ', 'Active', '通常取引可能状態', 1, '1', '02,09', 'SYSTEM', 'SYSTEM'),
('CMN_CUSTOMER_STATUS', '02', '休止', 'Suspended', '一時的な取引停止', 2, '1', '01,09', 'SYSTEM', 'SYSTEM'),
('CMN_CUSTOMER_STATUS', '09', '退会', 'Withdrawn', '契約終了', 9, '1', NULL, 'SYSTEM', 'SYSTEM');
```

### 5.3 コード取得SQL例

#### 5.3.1 基本的な取得

```sql
-- カテゴリ別コード取得（表示順）
SELECT
    code_value,
    code_name,
    code_name_en,
    description
FROM code_master
WHERE code_category = 'CMN_STATUS'
  AND valid_flag = '1'
ORDER BY display_order;
```

#### 5.3.2 階層構造の取得

```sql
-- 親子関係のあるコード取得
SELECT
    parent.code_value AS parent_code,
    parent.code_name AS parent_name,
    child.code_value AS child_code,
    child.code_name AS child_name
FROM code_master parent
LEFT JOIN code_master child
    ON parent.code_category = child.code_category
    AND parent.code_value = child.parent_code_value
WHERE parent.code_category = 'CMN_CATEGORY'
  AND parent.valid_flag = '1'
  AND (child.valid_flag = '1' OR child.code_value IS NULL)
ORDER BY parent.display_order, child.display_order;
```

## 6. 運用ルール

### 6.1 コードメンテナンス

| 作業 | 実施タイミング | 実施者 | 承認者 |
|------|----------------|--------|--------|
| 新規コード追加 | 機能追加時 | 開発担当者 | システムアーキテクト |
| コード名変更 | 要件変更時 | 開発担当者 | プロジェクトマネージャー |
| コード無効化 | 機能廃止時 | 開発担当者 | プロジェクトマネージャー |
| 定期レビュー | 四半期ごと | データベース管理者 | システムアーキテクト |

### 6.2 コード使用時の注意事項

1. **ハードコーディング禁止**: アプリケーション内でコード値を直接記述しない
2. **定数クラス使用**: Java定数クラスまたはEnumで管理すること
3. **キャッシュ利用**: 頻繁にアクセスするコードはキャッシュを使用すること
4. **国際化対応**: 多言語表示が必要な場合はcode_name_enを使用すること

### 6.3 データ整合性チェック

定期的に以下のチェックを実施すること:

```sql
-- 1. 重複コードチェック
SELECT code_category, code_value, COUNT(*)
FROM code_master
GROUP BY code_category, code_value
HAVING COUNT(*) > 1;

-- 2. 表示順序の重複チェック
SELECT code_category, display_order, COUNT(*)
FROM code_master
WHERE valid_flag = '1'
GROUP BY code_category, display_order
HAVING COUNT(*) > 1;

-- 3. 親コード存在チェック
SELECT child.*
FROM code_master child
LEFT JOIN code_master parent
    ON child.code_category = parent.code_category
    AND child.parent_code_value = parent.code_value
WHERE child.parent_code_value IS NOT NULL
  AND parent.code_value IS NULL;
```

## 7. 付録

### 7.1 コードカテゴリ一覧

| カテゴリコード | カテゴリ名 | 使用システム | 備考 |
|----------------|------------|--------------|------|
| CMN_STATUS | ステータスコード | A1, B1 | 汎用ステータス |
| CMN_PROJECT_STATUS | プロジェクトステータス | A1, B1 | プロジェクト管理用 |
| CMN_CUSTOMER_STATUS | 顧客ステータス | A1, B1 | 顧客管理用 |
| CMN_GENDER | 性別コード | A1, B1 | 個人情報用 |
| CMN_PREFECTURE | 都道府県コード | A1, B1 | 住所管理用 |
| CMN_PRIORITY | 優先度コード | A1, B1 | タスク管理用 |
| A1_ORDER_STATUS | 注文ステータス | A1 | A1システム固有 |
| B1_PRODUCT_TYPE | 商品区分 | B1 | B1システム固有 |

### 7.2 変更履歴

| 版数 | 変更日 | 変更内容 | 変更者 |
|------|--------|----------|--------|
| 1.0 | 2025-11-27 | 初版作成 | システムアーキテクト |

### 7.3 参考資料

- データベース設計標準
- コーディング規約
- システムアーキテクチャ設計書
- JIS X 0401（都道府県コード）

---

**文書管理**
- ファイルパス: `/設計書_Markdown/共通/コード設計書.md`
- 最終更新: 2025-11-27
- 承認者: システムアーキテクト
